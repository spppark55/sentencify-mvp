# ì•„í‚¤í…ì²˜, ë°ì´í„°ìŠ¤í‚¤ë§ˆ, íŠ¸ëœì­ì…˜

> **[ì°¸ê³ ] `P_rule` ë³€ê²½ ì´ë ¥**
> 
> ì´ˆê¸° Phase 1 ê¸°íš ë‹¹ì‹œì—ëŠ” `P_rule`(ê·œì¹™ ê¸°ë°˜ ì ìˆ˜)ê³¼ `P_vec`(ë²¡í„° ê¸°ë°˜ ì ìˆ˜)ë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ëª©í‘œì˜€ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì‹œìŠ¤í…œ ê²½ëŸ‰í™”ë¥¼ ìœ„í•´ `P_rule`ì´ ì ì •ì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì´í›„ Phase 2 ê°œë°œ ê³¼ì •ì—ì„œ íŠ¹ì • ë„ë©”ì¸ ì§€ì‹ì„ ë°˜ì˜í•  í•„ìš”ì„±ì´ ë‹¤ì‹œ ì œê¸°ë˜ì–´, **í˜„ì¬ ì•„í‚¤í…ì²˜(v2.4)ì—ëŠ” `P_rule`ì´ ë‹¤ì‹œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.** ì´ ë¬¸ì„œëŠ” `P_rule`ì´ í¬í•¨ëœ ìµœì‹  êµ¬ì¡°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.

ğŸ“˜ PART 1 â€” ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

ë³¸ ì ˆì€ ë¬¸ì¥êµì • ì¶”ì²œ ì‹œìŠ¤í…œì˜ ì „ì²´ ê¸°ìˆ  êµ¬ì¡°ë¥¼ ì‹¤ì‹œê°„ ê²½ë¡œ(Real-time Path), ì €ì¥ì†Œ(Storage), ë°°ì¹˜ ê²½ë¡œ(Offline Path) ì„¸ ê´€ì ì—ì„œ í‘œí˜„í•œë‹¤.
ì´ ì•„í‚¤í…ì²˜ëŠ” Phase 1~4 ì „ì²´ ê¸°ëŠ¥ì„ í¬í•¨í•˜ë©°, ê° Phaseì—ì„œ ìƒì„±Â·í™œìš©ë˜ëŠ” ëª¨ë“  ë°ì´í„° ìš”ì†Œ(A~I ìŠ¤í‚¤ë§ˆ), ê·¸ë¦¬ê³  ë…ë¦½ì ì¸ ì»¨í…ìŠ¤íŠ¸ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸(E: Micro / Kâ†’F: Macro)ì„ ëª…í™•íˆ ë¶„ë¦¬í•œ ìµœì¢… êµ¬ì¡°ë‹¤.

## 1-1. ì‹œìŠ¤í…œ ì „ì²´ êµ¬ì¡° (Real-time + Offline + Storage)

### ğŸ’¡ ìƒˆë¡­ê²Œ ë°˜ì˜ëœ í•µì‹¬ ì‚¬í•­ (v2.4 ì—…ë°ì´íŠ¸)

  * **Log Store ìµœì í™” (BigQuery â†’ MongoDB):** ëª¨ë“  ì´ë²¤íŠ¸ ë¡œê·¸(A~I)ë¥¼ Kafka Consumerê°€ Micro-Batch ë°©ì‹ìœ¼ë¡œ MongoDBì— ì§ì ‘ ì ì¬í•œë‹¤. (ë³µì¡í•œ ETL ì œê±°)
  * **Smart Ingester (Kafka Consumer):** Consumerê°€ ë‹¨ìˆœ ìˆ˜ì‹ ì„ ë„˜ì–´ ë°ì´í„° ì •ì œ, í¬ë§·íŒ…, ë°°ì¹˜ ì €ì¥ì„ ìˆ˜í–‰í•˜ëŠ” ê²½ëŸ‰ ETL ì›Œì»¤ ì—­í• ì„ ê²¸í•œë‹¤.
  * **Sidecar Dashboard (Streamlit):** ë³„ë„ì˜ ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì—†ì´, MongoDBì™€ Redisë¥¼ Read-Onlyë¡œ ì§ì ‘ ì¡°íšŒí•˜ì—¬ ì‹¤ì‹œê°„ ì§€í‘œë¥¼ ì‹œê°í™”í•œë‹¤.
  * **Rule Engine ($P_{	ext{rule}}$) ì¬ë„ì…:** ë„ë©”ì¸ íŠ¹í™” ê·œì¹™(ë§ì¶¤ë²•, ìŠ¤íƒ€ì¼ ê°€ì´ë“œ ë“±)ì„ ë°˜ì˜í•˜ê¸° ìœ„í•´ ë²¡í„° ê²€ìƒ‰($P_{	ext{vec}}$)ê³¼ ë³‘í–‰ ì‚¬ìš©í•œë‹¤.

### ğŸ’¡ í•µì‹¬ ì‚¬í•­ (v2.3 ìœ ì§€)

  * **ì‹ ë¢°ë„ ê¸°ë°˜ ì ì‘í˜• ìŠ¤ì½”ì–´ë§ (Adaptive Scoring):** ë¬¸ì„œ ì„±ìˆ™ë„(ê¸¸ì´)ì— ë”°ë¼ Macro($P_{	ext{doc}}$) ê°€ì¤‘ì¹˜($	ext{	extalpha}$)ë¥¼ ë™ì ìœ¼ë¡œ ì¡°ì ˆ.
  * **Full-Logging êµ¬ì¡°:** ìµœì¢… ì ìˆ˜ì— ë°˜ì˜ë˜ì§€ ì•ŠëŠ” ìš”ì†Œ($P_{	ext{doc}}$ ë“±)ë¼ë„ ê³„ì‚°ëœ ê°’ê³¼ ê°€ì¤‘ì¹˜ëŠ” ë°˜ë“œì‹œ ë¡œê·¸(I)ì— ë‚¨ê²¨ ì¶”í›„ ì‹œë®¬ë ˆì´ì…˜(Shadowing)ì´ ê°€ëŠ¥í•˜ë„ë¡ í•¨.
  * **Macro Context:** ë°˜ë“œì‹œ `K.full_document_store` â†’ `F.document_context_cache` ê²½ë¡œë¡œë§Œ ìƒì„±ë¨ (Eì™€ ì™„ì „ ë¶„ë¦¬).
  * **P_user, P_cluster ì¡°íšŒ:** Phase 3 ì´ìƒì—ì„œë§Œ í™œì„±í™”.
  * **Cache ê´€ë¦¬:** `editor_document_snapshot` â†’ K ì €ì¥ â†’ diff ê¸°ë°˜ ìºì‹œ ë¬´íš¨í™” ê·œì¹™(>=10%) ì¶”ê°€.
  * **Key ì—°ê²°:** A/B/Cë§Œ `recommend_session_id`ë¥¼ ê³µìœ í•˜ë©° D(correction_history)ëŠ” `correction_history_id`ë¡œë§Œ ì—°ê²°ëœë‹¤.

## 1-2. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
graph TD
  subgraph "ì‹¤ì‹œê°„ ê²½ë¡œ (Real-time Path)"
      direction LR

      User(ì‚¬ìš©ì) -- "1. ì¶”ì²œ ìš”ì²­ (HTTPS)\n(doc_id, context_text, user_id)" --> FE["í”„ë¡ íŠ¸ì—”ë“œ<br>(ì›¹ ì—ë””í„°)"]

      %% Phaseë³„ ì¡°íšŒ ë°˜ì˜
      FE -- "2. /recommend API í˜¸ì¶œ\n(P_rule / P_vec / P_doc? / P_user? / P_cluster?)" --> API["ì¶”ì²œ API ì„œë²„"]

      %% ìºì‹œ ê³„ì¸µ: 1.5(F), 2(G), 3(J)
      API -- "3. Macro ì¡°íšŒ (Phase1.5+)\nF.document_context_cache(doc_id)" --> CacheF["F ë§¤í¬ë¡œ ìºì‹œ<br>(Redis)"]
      API -- "4. User Profile ì¡°íšŒ (Phase2+)\nG.user_profile(user_id)" --> CacheG["G í”„ë¡œí•„ ìºì‹œ<br>(Redis)"]
      API -- "5. Cluster Profile ì¡°íšŒ (Phase3+)\nkey = G.user_profile.cluster_id" --> CacheJ["J í´ëŸ¬ìŠ¤í„° ìºì‹œ<br>(Redis)"]

      API --> EmbeddingModel(Micro-Window ì„ë² ë”©)
      API --> RuleEngine(ê·œì¹™ ê²€ì‚¬ê¸°)
      API --> ParaphrasingLLM(ì‹¤í–‰-B ë‹¨ê³„)
      ETL --> MacroLLM(Kâ†’F ë¶„ì„)

      API -- "6. Vector Search (Phase1+)\nE.context_block(context_hash)" --> VDB["E ë¬¸ë§¥ VectorDB"]

      API -- "7. P_final ê³„ì‚°\nP_final = (1 - alpha) * (w_vec * P_vec + w_rule * P_rule)\n+ alpha * P_doc + w_user * P_user + ..." --> API

      API -- "8. ì¶”ì²œ ê²°ê³¼ ë°˜í™˜\n(insert_id, ì¶”ì²œ ì˜µì…˜)" --> FE
      FE -- "9. ì‚¬ìš©ìì—ê²Œ ì¶”ì²œ ì˜µì…˜ í‘œì‹œ" --> User

      API -- "10. ë¹„ë™ê¸° ì´ë²¤íŠ¸ ë°œí–‰\n(editor_recommend_options, recommend_log)" --> MQ["ë©”ì‹œì§€ í<br>(Kafka)"]

      User -- "11. ë¬¸ì„œ ì €ì¥/íƒ€ì´í•‘" --> FE
      FE -- "12. editor_document_snapshot ë°œí–‰" --> MQ
  end

  %% Storage Layer (Unified MongoDB) - Data Persistence
  subgraph "ë°ì´í„° ì €ì¥ì†Œ (Unified Storage - MongoDB)"
      MQ -- "13a. Smart Consumer (Group 1)" --> Consumer["Kafka Consumer<br>(Ingester Worker)"]
      
      Consumer -- "14. ë¡œê·¸ ì ì¬ (A/B/C/I)" --> MongoLogs["ë¡œê·¸ ì»¬ë ‰ì…˜<br>(log_a, log_b, log_i...)"]
      Consumer -- "15. ë¬¸ì„œ ì›ë³¸ ì €ì¥ (K)" --> MongoDocs["ë¬¸ì„œ ì»¬ë ‰ì…˜<br>(full_document_store)"]
      
      Consumer -- "16. Micro Context (E)" --> ContextDB["E ë¬¸ë§¥ DB (Vector Store)"]
      
      FE -- "17. Ground Truth (D)" --> MongoLogs
  end

  %% Monitoring Layer (ELK Stack) - Observability
  subgraph "ì‹¤ì‹œê°„ ê´€ì œ (ELK Stack)"
      MQ -- "13b. Logstash Consumer (Group 2)" --> Logstash["Logstash"]
      Logstash --> ES["Elasticsearch"]
      ES --> Kibana["ğŸ“ˆ Kibana Dashboard<br>(Real-time Monitoring)"]
  end

  %% Offline Path & Analytics
  subgraph "ë¶„ì„ ë° ì‹œê°í™” (Analytics)"
      ETL["ETL íŒŒì´í”„ë¼ì¸ (Python Script)"]

      %% Macro Context ë°°ì¹˜
      MongoDocs -- "18a. ë¬¸ì„œ ì›ë³¸ ì½ê¸° (Diff Check)" --> ETL
      ETL -- "19a. LLM ë¶„ì„ â†’ Macro ìºì‹œ ìƒì„±" --> CacheF

      %% Dashboard (Admin Tool)
      MongoLogs -- "20. ë°ì´í„° ë¶„ì„/ê´€ë¦¬" --> AdminDash["ğŸ“Š Streamlit Admin<br>(Analytics & Inspector)"]
      MongoDocs -- "21. ë¬¸ì„œ/í–‰ë™ ë¶„ì„" --> AdminDash
      CacheF -- "22. ìºì‹œ ìƒíƒœ ëª¨ë‹ˆí„°ë§" --> AdminDash
      
      %% User Profile
      MongoLogs -- "23. ë¡œê·¸ ì§‘ê³„" --> ETL
      ETL -- "24. user_profile(G) ìƒì„±" --> CacheG
  end

  style CacheF fill:#fff2cc
  style CacheG fill:#fff2cc
  style CacheJ fill:#fff2cc
  style User fill:#cde4ff
  style FE fill:#cde4ff
  style API fill:#cde4ff
  style ETL fill:#d5e8d4
  style AdminDash fill:#ffe6cc
  style Kibana fill:#f8cecc
```

## 1-3. Real-time Path ìƒì„¸ ì„¤ëª…

### (1) ì¶”ì²œ ìš”ì²­ (User â†’ FE â†’ API)
... (ê¸°ì¡´ ë‚´ìš© ìœ ì§€) ...

### (8) ë¹„ë™ê¸° ë°ì´í„° ì €ì¥ ë° ê´€ì œ

APIëŠ” ê²°ê³¼ë¥¼ FEë¡œ ë°˜í™˜í•œ ë’¤, ë¹„ë™ê¸° í(Kafka)ë¥¼ í†µí•´ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•©ë‹ˆë‹¤. ì´ë•Œ **Consumer Group ë¶„ë¦¬**ë¥¼ í†µí•´ ì €ì¥ê³¼ ê´€ì œê°€ ë³‘ë ¬ë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤.

  * **ë°ì´í„° ì €ì¥ (Group 1):** Python Consumerê°€ MongoDBì— ì ì¬ (ë°ì´í„° ë³´ì¡´, ETL ì†ŒìŠ¤).
  * **ì‹¤ì‹œê°„ ê´€ì œ (Group 2):** Logstashê°€ Kafkaë¥¼ ì§ì ‘ êµ¬ë…í•˜ì—¬ Elasticsearchì— ì ì¬ (Kibana ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§).

## 1-4. Storage & Monitoring Layer ìƒì„¸ ì„¤ëª…

  * **(Storage - MongoDB):** ëª¨ë“  ë¡œê·¸(A~I)ì™€ ì›ë³¸ ë¬¸ì„œ(K), ê¸°ì—… ë°ì´í„°(D)ì˜ **ì˜êµ¬ ì €ì¥ì†Œ(Persistence Layer)**ì´ì ETL íŒŒì´í”„ë¼ì¸ì˜ ì›ì²œ(Source).
  * **(Monitoring - ELK Stack):** ë¡œê·¸ ê²€ìƒ‰, íŠ¸ëœì­ì…˜ ì¶”ì , ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œë¥¼ ë‹´ë‹¹í•˜ëŠ” **ê´€ì œ í”Œë«í¼(Observability Layer)**. MongoDB ì¥ì•  ì‹œì—ë„ ë…ë¦½ì ìœ¼ë¡œ ì‘ë™í•˜ì—¬ ì‹œìŠ¤í…œ ìƒíƒœë¥¼ ì „íŒŒí•œë‹¤.
  * **(Admin Tool - Streamlit):** ì‹¤ì‹œê°„ ê´€ì œ ì—­í• ì€ ELKë¡œ ì´ê´€í•˜ê³ , **ë°ì´í„° ì‹¬ì¸µ ë¶„ì„(Analytics)**, ë¹„ìš© ê³„ì‚°(ROI), ê°œë³„ ì„¸ì…˜ ìƒì„¸ ì¡°íšŒ(Inspector) ë“± **ê´€ë¦¬ì ë„êµ¬** ì—­í• ì— ì§‘ì¤‘í•œë‹¤.

## 1-5. Offline / Batch Path ìƒì„¸ ì„¤ëª…
... (ê¸°ì¡´ ë‚´ìš© ìœ ì§€) ...

## 1-5. Offline / Batch Path ìƒì„¸ ì„¤ëª…

1.  **K â†’ F Macro Context Generation:** Kì˜ `full_document_store`ë¥¼ ì½ê³  `diff ratio >= 10%` ì‹œ LLM ë¶„ì„ í›„ F ì—…ë°ì´íŠ¸.
2.  **A/B/C/D/E/I â†’ ETL íŒŒì´í”„ë¼ì¸:** `training_examples`(H), `user_profile`(G), `cluster_profile`(J) ìƒì„±.
3.  **MongoDB(H) â†’ ES Golden Data Sync (New in Phase 2.5):**
    *   **ì—­í• :** ETLì´ ìƒì„±í•œ `training_examples`(H)ë¥¼ Elasticsearchì˜ `sentencify-golden-*` ì¸ë±ìŠ¤ë¡œ ë™ê¸°í™”í•˜ì—¬ BI ëŒ€ì‹œë³´ë“œ(Kibana)ì— ì œê³µ.
    *   **ë°©ì‹:** Python Batch Worker (`scripts/sync_golden_to_es.py`) ì‚¬ìš©.
    *   **ì£¼ê¸°:** ê°œë°œ í™˜ê²½(5ë¶„ë§ˆë‹¤) / ìš´ì˜ í™˜ê²½(ETL ì™„ë£Œ í›„ ì¦‰ì‹œ íŠ¸ë¦¬ê±°).
    *   **Future Scalability:** ë°ì´í„° ê·œëª¨ê°€ ì»¤ì§€ë©´ Airflow DAGë¡œ í†µí•©í•˜ê±°ë‚˜ Kafka Connect(Source Connector)ë¥¼ ë„ì…í•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™”ë¡œ í™•ì¥ ê°€ëŠ¥.

## 1-6. ìºì‹œ ê³„ì¸µ (F/G/J) ì •ì±…

  * **F(document_context_cache):** ê¸°ë³¸ TTL 1ì‹œê°„. ë¬¸ì„œ ìˆ˜ì • ë¹ˆë„ì— ë”°ë¼ ë‹¨ì¶•. `diff_ratio>=10%` ì‹œ ì¦‰ì‹œ ë¬´íš¨í™”.
  * **G(user_profile) / J(cluster_profile):** ë¬´í•œ TTL (ETL ë°°ì¹˜ ì‹¤í–‰ ì‹œ ë®ì–´ì“°ê¸°).

-----

ì œì‹œí•´ì£¼ì‹  **v2.4(ìš”ì•½ ë° ìµœì‹  íë¦„)**ì˜ ë¼ˆëŒ€ì— **v2.3(ìƒì„¸ êµ¬í˜„ ë° ë°ì´í„° ìŠ¤í™)**ì˜ êµ¬ì²´ì ì¸ ë‚´ìš©ì„ í†µí•©í•˜ì—¬, **ëª¨ìˆœ ì—†ì´ ìƒì„¸í™”ëœ v2.4 í†µí•© ëª…ì„¸ì„œ**ë¥¼ ì‘ì„±í•´ ë“œë¦½ë‹ˆë‹¤.

ì´ ë¬¸ì„œëŠ” v2.4ì˜ ìµœì‹  ë¡œì§(Rule+Vector ê²°í•© ë“±)ì„ ë”°ë¥´ë˜, v2.3ì˜ êµ¬ì²´ì ì¸ ë°ì´í„° í•„ë“œ, ì„¸ì…˜ ê´€ë¦¬ ê·œì¹™, ì•„í‚¤í…ì²˜ ì„¸ë¶€ ì‚¬í•­ì„ ë³´ê°•í–ˆìŠµë‹ˆë‹¤.

---

# ğŸ“˜ PART 2 â€” Phaseë³„ ìƒì„¸ ëª…ì„¸ (Integrated v2.4)

**(Phase 1 â†’ Phase 1.5 â†’ Phase 2 â†’ Phase 3 â†’ Phase 4)**

---

## ğŸŸ¦ Phase 1: ì‹¤ì‹œê°„ ì¶”ì²œ MVP + Hooks ìˆ˜ì§‘ (v1.0)

**ëª©í‘œ:** ì‚¬ìš©ìê°€ ë¬¸ì¥ì„ ë“œë˜ê·¸í–ˆì„ ë•Œ, **Rule/Vector ê¸°ë°˜ ì ìˆ˜**ë¥¼ í†µí•´ ì¦‰ê°ì ì¸ ì¹´í…Œê³ ë¦¬ ì¶”ì²œì„ ì œê³µí•˜ê³ , ë¯¸ë˜ë¥¼ ìœ„í•œ í•µì‹¬ "Hooks(ë°ì´í„° ê³ ë¦¬)"ë¥¼ ì™„ë²½í•˜ê²Œ ìˆ˜ì§‘í•œë‹¤.

### 1. Phase 1ì—ì„œ ë‹¬ì„±í•´ì•¼ í•˜ëŠ” ê²ƒ

* **ì‹¤ì‹œê°„ ì¶”ì²œ ë¡œì§ ($P_{	ext{rule}}, P_{	ext{vec}}$):**
    * ê·œì¹™ ê¸°ë°˜ì˜ ì •ë°€í•¨(ë§ì¶¤ë²•, ê¸ˆì¹™ì–´)ê³¼ ë²¡í„° ê¸°ë°˜ì˜ ë²”ìš©ì„±(ìœ ì‚¬ ë¬¸ë§¥) ê²°í•©.
    * ì¶”ì²œ ì‘ë‹µ ì†ë„ **300ms ì´ë‚´** ë‹¬ì„±.
* **Micro-Context ìˆ˜ì§‘ (E):**
    * "ì„ íƒ êµ¬ê°„ ìœˆë„ìš°" ë‹¨ìœ„ì˜ ë¬¸ë§¥ ë° ì„ë² ë”© ì €ì¥.
    * `doc_id` ê¸°ë°˜ ìˆ˜ì§‘ ì²´ê³„ ë§ˆë ¨.
* **A/B/C/D íŠ¸ëœì­ì…˜ ì—°ê²°:**
    * **Session Consistency:** APIê°€ ë°œê¸‰í•œ `recommend_session_id`ë¡œ A, B, C ì´ë²¤íŠ¸ë¥¼ ë¬¶ìŒ.
    * **Ground Truth ì—°ê²°:** C(ì„ íƒ) ë°œìƒ ì‹œ D(êµì • ì´ë ¥)ë¥¼ ìƒì„±í•˜ê³  `correction_history_id`ë¡œ ìµœì¢… ì—°ê²°.

### 2. Phase 1 ì•„í‚¤í…ì²˜ íë¦„

1.  **ì‚¬ìš©ì â†’ FE â†’ API ìš”ì²­:**
    * ì „ì†¡ ë°ì´í„°: `doc_id`, `context_text`, `context_hash`, `user_id`.
    * **ì¤‘ìš”:** `recommend_session_id`ëŠ” í•­ìƒ **API ì„œë²„ê°€ ìƒì„±**í•˜ì—¬ ì‘ë‹µí•œë‹¤.
2.  **ì¶”ì²œ ì—”ì§„ ($P_{	ext{rule}}, P_{	ext{vec}}$ ê³„ì‚°):**
    * **$P_{	ext{vec}}$ (Vector):** Embedding Model(v1) â†’ KNN Search (Top-k=15, Synthetic DB í™œìš©).
    * **$P_{	ext{rule}}$ (Rule):** Rule Engine ê²€ì‚¬ (ë§ì¶¤ë²•, ì ˆëŒ€ ê¸ˆì¹™ì–´, í•„ìˆ˜ êµì • ì‚¬í•­).
3.  **$P_{	ext{final}}$ ê³„ì‚° (Hybrid Scoring):**
    * $$P_{	ext{final}} = w_{	ext{vec}} 	imes P_{	ext{vec}} + w_{	ext{rule}} 	imes P_{	ext{rule}}$$
    * *Note:* Phase 1ì—ì„œëŠ” Macro($P_{	ext{doc}}$) ë° ê°œì¸í™”($P_{	ext{user}}$) ì ìˆ˜ëŠ” 0ìœ¼ë¡œ ì²˜ë¦¬(ë°ì´í„° ìˆ˜ì§‘ë§Œ ìˆ˜í–‰).
4.  **ì¶”ì²œ ê²°ê³¼ ë°˜í™˜ ë° A ì´ë²¤íŠ¸ ìƒì„±:**
    * **A (Editor Recommend Options):** `insert_id`, `recommend_session_id`, `P_vec`, `P_rule`, `model_version` ì €ì¥.
5.  **ë¬¸ì„œ Hooks ìˆ˜ì§‘ (ë¹„ë™ê¸°):**
    * **E (Context Block):** ë¬¸ë§¥ í…ìŠ¤íŠ¸ Preview, `embedding_v1`, `embedding_version="v1.0"` ì €ì¥.
6.  **ì‹¤í–‰(B) / ì„ íƒ(C) / ê¸°ë¡(D) ì—°ê²°:**
    * FEëŠ” API ì‘ë‹µë°›ì€ `recommend_session_id`ë¥¼ B, C ì´ë²¤íŠ¸ì— í¬í•¨í•˜ì—¬ ì „ì†¡.
    * C(ì„ íƒ) ë°œìƒ ì‹œ D(Ground Truth)ê°€ ìƒì„±ë˜ë©°, Dì˜ IDê°€ Cì— ì—…ë°ì´íŠ¸ë¨.

### 3. Phase 1 ë°ì´í„° ë° ìŠ¤í‚¤ë§ˆ

* **ìƒì„± (Write):**
    * `E.context_block`: Micro Context ì›ì²œ ë°ì´í„°.
    * `A.editor_recommend_options`: ì¶”ì²œ ë‹¹ì‹œì˜ ìƒí™© ë° ëª¨ë¸ ì ìˆ˜.
    * `I.recommend_log`: ì‹œìŠ¤í…œ ë¡œê·¸ ë° Latency ì •ë³´.
* **í™œìš© (Read):**
    * `Synthetic Embedding DB`: ì´ˆê¸° ì½œë“œ ìŠ¤íƒ€íŠ¸ í•´ê²°ìš© ê°€ìƒ ë°ì´í„°.
    * `Rule Set`: ì •ì  ê·œì¹™ ë°ì´í„°.

### 4. Phase 1 ì™„ë£Œ ê¸°ì¤€

* ì¶”ì²œ ì‘ë‹µ Latency **300ms ì´ë‚´**.
* `E.context_block` ìƒì„±ë¥  **99% ì´ìƒ**.
* `recommend_session_id` ê¸°ë°˜ì˜ **Aâ€“Bâ€“Câ€“D ì²´ì¸ ì„±ê³µë¥  99%** (ë°ì´í„° ëˆ„ë½ ì—†ìŒ).
* Schema Versioning (Backward-compatibility) ê²€ì¦ ì™„ë£Œ.

---

## ğŸŸ¦ğŸŸ© Phase 1.5: Macro Context Hybrid (v1.5)

**ëª©í‘œ:** ë¬¸ì„œì˜ ë¶€ë¶„(Micro) ëŒ€ì‹  **ì „ì²´ ë¬¸ì„œ(Macro)** ì •ë³´ë¥¼ í™œìš©í•˜ì—¬, íŠ¹ì • ë¬¸ì¥ë§Œ ë³´ê³  ë°œìƒí•˜ëŠ” ì˜¤ì¶”ì²œì„ ë¬¸ì„œ ì „ì²´ ë§¥ë½ìœ¼ë¡œ ë³´ì •í•œë‹¤.

### 1. ìƒì„¸ ê¸°ëŠ¥ ì„¤ëª…

* **K.full_document_store ì €ì¥ (Snapshot):**
    * ë¬¸ì„œ ì €ì¥/ìë™ ì €ì¥ ì‹œ `editor_document_snapshot` ì´ë²¤íŠ¸ ë°œí–‰.
    * FEëŠ” Diffë§Œ ë³´ë‚´ê³ , ì„œë²„ê°€ `prev_full_text`ì™€ í•©ì³ `K.latest_full_text`ë¥¼ ê°±ì‹ .
* **ETL íŒŒì´í”„ë¼ì¸ (K â†’ LLM â†’ F):**
    * Diffê°€ 10% ì´ìƒì´ê±°ë‚˜, ë¬¸ì„œì˜ ì£¼ìš” êµ¬ì¡°ê°€ ë³€ê²½ëœ ê²½ìš° Trigger.
    * LLMì´ `macro_topic`, `macro_category_hint`, `tone_manner` ì¶”ì¶œ.
    * ê²°ê³¼ëŠ” **Redis(F.document_context_cache)**ì— K-V í˜•íƒœë¡œ ì €ì¥ (`valid_until`, `updated_at` í¬í•¨).
* **ì¶”ì²œ ë¡œì§ ì—…ê·¸ë ˆì´ë“œ (ë™ì  ê°€ì¤‘ì¹˜ $	ext{	extalpha}$):**
    * **ë¬¸ì„œ ì„±ìˆ™ë„(Maturity) ê°œë… ë„ì…:**
        * **Cold Start (0~50ì):** $	ext{	extalpha} = 0$ (Micro 100% ì˜ì¡´).
        * **Growing (50~500ì):** ë¬¸ì„œ ì–‘ì— ë¹„ë¡€í•˜ì—¬ $	ext{	extalpha}$ ì ì§„ì  ì¦ê°€.
        * **Mature (500ì+):** ìµœëŒ€ $	ext{	extalpha}$ ì ìš© (Macroê°€ ê°•ë ¥í•œ ê°€ì´ë“œë¼ì¸ ì—­í• ).
    * **ê³µì‹:** $$P_{	ext{final}} = (1 - 	ext{	extalpha}) 	imes P_{	ext{micro}} + 	ext{	extalpha} 	imes P_{	ext{doc}}$$
* **ìºì‹œ ë¬´íš¨í™” ì •ì±… (Cache Invalidation):**
    * `diff_ratio >= 0.10` (ëŒ€ëŸ‰ ìˆ˜ì • ì‹œ ì¦‰ì‹œ ë¬´íš¨í™”).
    * TTL(Time To Live) ë§Œë£Œ ì‹œ.
    * ì‚¬ìš©ìê°€ ë¬¸ì„œ ì–¸ì–´ ì„¤ì •ì„ ë³€ê²½í–ˆì„ ë•Œ.

### 2. Phase 1.5 ì™„ë£Œ ê¸°ì¤€

* `F.cache` (Redis) ìƒì„±ë¥  ë° Hit Rate **97% ì´ìƒ**.
* $P_{	ext{doc}}$ ì ìˆ˜ ë°˜ì˜ ë° ë¬¸ì„œ ê¸¸ì´ì— ë”°ë¥¸ ë™ì  ê°€ì¤‘ì¹˜($	ext{	extalpha}$) ì‘ë™ ê²€ì¦.
* Macro ì •ë³´ ë³€ê²½ ì‹œ ìºì‹œê°€ ì ì ˆíˆ ê°±ì‹ (Reset)ë˜ëŠ”ì§€ í™•ì¸.

---

## ğŸŸ¦ğŸŸ¨ Phase 2: ë°ì´í„° ì¶•ì  / í•™ìŠµ íŒŒì´í”„ë¼ì¸ (v2.0)

**ëª©í‘œ:** ìˆ˜ì§‘ëœ ë¡œê·¸(A~I)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ **í•™ìŠµ ë°ì´í„°(H)**ì™€ **ì‚¬ìš©ì í”„ë¡œí•„(G)**ì„ ìƒì„±í•˜ê³ , **ëŒ€ì‹œë³´ë“œ**ë¥¼ í†µí•´ ë°ì´í„° ìì‚°ì˜ ê°€ì¹˜ë¥¼ ì‹œê°í™”í•œë‹¤.

### 1. Phase 2 í•µì‹¬ ë³€í™”

* **Training Examples ìƒì„± (H):**
    * A(ì¶”ì²œ), B(ì‹¤í–‰), C(ì„ íƒ), D(ìµœì¢…ìˆ˜ì •), E(ë¬¸ë§¥), F(ë§¤í¬ë¡œ)ë¥¼ ì¡°ì¸í•˜ì—¬ ì§€ë„ í•™ìŠµ(Supervised Learning) ë°ì´í„°ì…‹ ìƒì„±.
* **User Profile ìƒì„± (G):**
    * ì‚¬ìš©ìë³„ ì„ í˜¸ ì¹´í…Œê³ ë¦¬, ê°•ë„(Intensity), ì–¸ì–´ íŒ¨í„´ ë“±ì„ ì§‘ê³„í•˜ì—¬ ë²¡í„°í™”.
    * JSON Object ëŒ€ì‹  **ê³ ì • ê¸¸ì´ ë²¡í„°(Fixed-length Vector)**ë¡œ ë³€í™˜í•˜ì—¬ ì¡°íšŒ ìµœì í™”.
* **Vector DB Hybrid ì „í™˜:**
    * ë°ì´í„°ê°€ ì¶©ë¶„íˆ ìŒ“ì¸ ì²­í¬ë¶€í„° Synthetic DB â†’ **Real User Embedding DB**ë¡œ ì „í™˜.

### 2. Session Consistency Rule (ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦)

ë°ì´í„°ì…‹(H) ìƒì„± ì‹œ ë‹¤ìŒ ê·œì¹™ì„ ì—„ê²©íˆ ì ìš©í•˜ì—¬ "Golden Data"ë§Œ ì„ ë³„í•œë‹¤.

* **Time Check:** `abs(A.timestamp - B.timestamp) > 5s` ì¸ ê²½ìš° `low_consistency` ë§ˆí‚¹.
* **Source Check:** `B.source_id != A.insert_id` ì¸ ê²½ìš° Drop.
* **Outcome Check:** `C.was_accepted == False` ì´ì§€ë§Œ `D.selected_index`ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°(ëª¨ìˆœ) ì—ëŸ¬ ì²˜ë¦¬.
* ëª¨ë“  `training_examples`ì—ëŠ” `consistency_flag` (High/Low)ê°€ ë¶€ì—¬ë¨.

-----

### 3. Analytics Dashboard V1 (Streamlit) & Data Value Visualization

* docs/dashboard_spec.md ì°¸ê³ 



---

## ğŸŸ¦ğŸŸ§ Phase 3: ê°œì¸í™” ì¶”ì²œ (v3.0)

**ëª©í‘œ:** User Profile(G)ê³¼ Cluster Profile(J)ì„ ê¸°ë°˜ìœ¼ë¡œ, "ë‚˜ì™€ ë¹„ìŠ·í•œ ì‚¬ìš©ì" ë° "ë‚˜ì˜ ê³¼ê±° íŒ¨í„´"ì„ ë°˜ì˜í•œ ì´ˆê°œì¸í™” ì¶”ì²œì„ ì œê³µí•œë‹¤.

### 1. Phase 3 í•µì‹¬ ë³€í™”

* **User Embedding ($P_{	ext{user}}$):**
    * User Profile(G)ì„ ì¸ì½”ë”©í•˜ì—¬ ì‚¬ìš©ì í–‰ë™ ë²¡í„° ìƒì„± (ì˜ˆ: BERT ê¸°ë°˜ Behavioral Embedding).
    * ê°œì¸í™” ì ìˆ˜ $P_{	ext{user}}$ í™œì„±í™”.
* **Cluster Profile ($P_{	ext{cluster}}$ / J):**
    * ìœ ì‚¬ ì‚¬ìš©ì ê·¸ë£¹(Cluster)ì„ ì •ì˜í•˜ê³ , í•´ë‹¹ ê·¸ë£¹ì˜ ì„ í˜¸ë„ë¥¼ ì¶”ì²œì— ë³´ì •.
    * **ì¡°íšŒ ë¡œì§:** `User Profile` â†’ `Cluster ID` í™•ì¸ â†’ `Cluster Profile(J)` ì¡°íšŒ.
* **Predictor ëª¨ë¸ ë„ì…:**
    * **Strength Predictor:** (Context + User Emb) â†’ "Weak/Moderate/Strong" ê°•ë„ ìë™ ì œì•ˆ.
    * **Language Predictor:** (Context + User Emb) â†’ ì ì ˆí•œ ë°˜í™˜ ì–¸ì–´ ì˜ˆì¸¡.

### 2. ì¶”ì²œ ë¡œì§ í™•ì¥

* **ìµœì¢… ì ìˆ˜ ê³µì‹:**
    $$P_{	ext{final}} = f(P_{	ext{vec}}, P_{	ext{rule}}, P_{	ext{doc}}, P_{	ext{user}}, P_{	ext{cluster}})$$
* **$P_{	ext{user}}$ ê³„ì‚°:** ì‚¬ìš©ì ì„ë² ë”©ê³¼ ì¹´í…Œê³ ë¦¬ ì„¼íŠ¸ë¡œì´ë“œ ê°„ì˜ Cosine Similarity.
* **$P_{	ext{cluster}}$ ê³„ì‚°:** ì‚¬ìš©ìê°€ ì†í•œ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì¸ê¸°/ìˆ˜ìš©ë„.

### 3. Phase 3 ì™„ë£Œ ê¸°ì¤€

* $P_{	ext{user}}$ ë° $P_{	ext{cluster}}$ ì ìˆ˜ê°€ ì¶”ì²œ ìˆœìœ„ì— ìœ ì˜ë¯¸í•œ ì˜í–¥ì„ ë¯¸ì¹¨.
* Cluster Profile(J) ì¡°íšŒ ì„±ê³µë¥  95% ì´ìƒ.
* ê°•ë„/ì–¸ì–´ Predictorì˜ ì •í™•ë„ê°€ ê¸°ì¤€ì¹˜(ì˜ˆ: 85%) ë‹¬ì„±.

---

## ğŸŸ¥ Phase 4: ì„œìˆ í˜• ì˜µì…˜ ìë™í™” (v4.0)

**ëª©í‘œ:** ì •í•´ì§„ ì˜µì…˜ì„ ê³ ë¥´ëŠ” ê²ƒì„ ë„˜ì–´, LLMì´ ë¬¸ë§¥(Micro+Macro)ê³¼ ì‚¬ìš©ì ìŠ¤íƒ€ì¼(Profile)ì„ ëª¨ë‘ ê³ ë ¤í•˜ì—¬ **ì„œìˆ í˜• ì˜µì…˜(User Prompt)ì„ ìë™ ìƒì„±**í•œë‹¤.

### 1. Phase 4 í•µì‹¬ ìš”ì†Œ

* **Tone/Style Generator:**
    * ì‚¬ìš©ìì˜ ê³¼ê±° `user_prompt` ì´ë ¥(D)ì„ í•™ìŠµí•˜ì—¬, ì‚¬ìš©ìê°€ ìì£¼ ì“°ëŠ” "ë§íˆ¬"ë‚˜ "ìš”ì²­ ìŠ¤íƒ€ì¼"ì„ ì¬í˜„.
    * ì˜ˆ: "ì¢€ ë” ì •ì¤‘í•˜ê²Œ ë³€ê²½í•´ì¤˜" vs "í•µì‹¬ë§Œ ê°„ë‹¨íˆ ìš”ì•½í•´"
* **Prompt Composer (í•µì‹¬ ì—”ì§„):**
    * LLMì—ê²Œ ì „ë‹¬í•  ìµœì¢… í”„ë¡¬í”„íŠ¸ë¥¼ ì¡°ë¦½í•˜ëŠ” ëª¨ë“ˆ.
    * **ì…ë ¥:** Micro Context(E) + Macro Summary(F) + User Profile(G) + Predicted Style.
    * **ì¶œë ¥:** LLM Instruction Prompt.
* **Feedback Loop ê°•í™”:**
    * ìë™ ìƒì„±ëœ í”„ë¡¬í”„íŠ¸ê°€ ì„ íƒ(C)ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ë‹¤ì‹œ í•™ìŠµí•˜ì—¬ ëª¨ë¸ì„ ë¯¸ì„¸ ì¡°ì •.

### 2. Phase 4 ì™„ë£Œ ê¸°ì¤€

* ì‚¬ìš©ìê°€ ë³„ë„ì˜ íƒ€ì´í•‘ ì—†ì´, ì‹œìŠ¤í…œì´ ì œì•ˆí•œ "ì„œìˆ í˜• ì˜µì…˜"ì„ í´ë¦­í•˜ì—¬ êµì • ìˆ˜í–‰.
* ì¶”ì²œ â†’ ì‹¤í–‰ â†’ ì„ íƒ(ìˆ˜ë½)ê¹Œì§€ì˜ End-to-End ìë™í™” íŒŒì´í”„ë¼ì¸ ì™„ì„±.

-----

ğŸ“˜ PART 3 â€” ì „ì²´ ìŠ¤í‚¤ë§ˆ (v2.4 ì—…ë°ì´íŠ¸)

ì œì‹œí•´ì£¼ì‹  **v2.3(ìƒì„¸ í•„ë“œ ì •ì˜)**ê³¼ **v2.4(ë¡œì§ ë³€ê²½ì‚¬í•­)**ë¥¼ ì™„ë²½í•˜ê²Œ í†µí•©í•˜ì—¬, **v2.4 ê¸°ì¤€ì˜ ì™„ì „í•œ ìŠ¤í‚¤ë§ˆ ëª…ì„¸ì„œ**ë¥¼ ì‘ì„±í•´ ë“œë¦½ë‹ˆë‹¤.

ë¬¸ì„œ í•˜ë‹¨ì— **"v2.3 ëŒ€ë¹„ v2.4ì˜ ì£¼ìš” ë³€ê²½ì (Diff Report)"**ì„ ë³„ë„ë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.

-----

# ğŸ“˜ PART 3 â€” ì „ì²´ ìŠ¤í‚¤ë§ˆ (Integrated v2.4)

**(A~L ì „ì²´ í•„ë“œ í¬í•¨ / Rule Engine í•„ë“œ ì¶”ê°€ / v2.4 ë¡œì§ ë°˜ì˜)**

-----

### ğŸŸ¦ A. editor_recommend_options (Phase 1~3 í•µì‹¬ ì‹¤ì‹œê°„ ë¡œê·¸)

**ì„¤ëª…:** ì¶”ì²œì´ ìƒì„±ë  ë•Œë§ˆë‹¤ ê¸°ë¡ë˜ëŠ” ì´ë²¤íŠ¸. v2.4ì—ì„œ **Rule ê¸°ë°˜ ì ìˆ˜($P_{	ext{rule}}$)** í•„ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.

```json
{
  "insert_id": "string",                    // PK, UUID
  "recommend_session_id": "string",         // A/B/C/D ì—°ê²°ìš© ì„¸ì…˜ ID (Backend ìƒì„±)
  "user_id": "string",
  "doc_id": "string",
  "context_hash": "string",

  "reco_category_input": "string",          // ìµœì¢… ì¶”ì²œ ê²°ê³¼(top-1)
  "reco_options": ["object"],               // í›„ë³´ ì˜µì…˜ ë¦¬ìŠ¤íŠ¸ (Phase 3+: {category, strength})

  // --- Scoring Details ---
  "P_vec":  { "category": "number" },       // Vector ê¸°ë°˜ ì ìˆ˜ (KNN)
  "P_rule": { "category": "number" },       // (v2.4 ì‹ ê·œ) Rule ê¸°ë°˜ ì ìˆ˜ 
  "P_doc":  { "category": "number" },       // Macro ê¸°ë°˜ ì ìˆ˜ (Phase 1.5+)
  "P_user": { "category": "number" },       // User ê¸°ë°˜ ì ìˆ˜ (Phase 3+)
  "P_cluster": { "category": "number" },    // Cluster ê¸°ë°˜ ì ìˆ˜ (Phase 3+)

  // --- Weights & Parameters ---
  "weight_vec": "number",
  "weight_rule": "number",                  // (v2.4 ì‹ ê·œ)
  "weight_doc": "number",
  "weight_user": "number",
  "weight_cluster": "number",
  
  "doc_maturity_score": "number",           // 0.0~1.0 (ë¬¸ì„œ ê¸¸ì´ì— ë”°ë¥¸ ì„±ìˆ™ë„)
  "applied_weight_doc": "number",           // ì‹¤ì œ ì ìš©ëœ alpha ê°’ (Macro ê°€ì¤‘ì¹˜)

  // --- Metadata ---
  "model_version": "string",
  "api_version": "string",
  "schema_version": "string",

  "cache_hit_macro": "boolean",             // F(document_context_cache) hit ì—¬ë¶€
  "cache_hit_user": "boolean",              // G(user_profile) hit ì—¬ë¶€
  "cache_hit_cluster": "boolean",           // J(cluster_profile) hit ì—¬ë¶€

  "created_at": "datetime",
  "embedding_version": "string",
  "llm_version": "string"                   // (Optional)
}
```

### ğŸŸ¦ B. editor_run_paraphrasing (Phase 1 ì‹¤í–‰ ì´ë²¤íŠ¸)

**ì„¤ëª…:** ì¶”ì²œ ì˜µì…˜ì„ ì‚¬ìš©ìê°€ í´ë¦­í•˜ì—¬ 'ì‹¤í–‰(Run)'í–ˆì„ ë•Œ ë°œìƒí•˜ëŠ” ë¡œê·¸.

```json
{
  "source_recommend_event_id": "string",   // A.insert_id ì°¸ì¡°
  "recommend_session_id": "string",        // Aì™€ ë™ì¼í•œ Session ID

  "doc_id": "string",
  "user_id": "string",

  "target_language": "string",             // ko/en/jp ë“±
  "target_intensity": "string",            // weak / moderate / strong
  "target_category": "string",

  "executed_at": "datetime",
  "created_at": "datetime",
  "paraphrase_llm_version": "string"
}
```

### ğŸŸ¦ C. editor_selected_paraphrasing (Phase 1 ì„ íƒ ì´ë²¤íŠ¸)

**ì„¤ëª…:** ìˆ˜ì •ëœ í›„ë³´ ì¤‘ ì‚¬ìš©ìê°€ ìµœì¢…ì ìœ¼ë¡œ 'ì„ íƒ(Apply)'í–ˆëŠ”ì§€ ì—¬ë¶€.

```json
{
  "source_recommend_event_id": "string",   // A.insert_id ì°¸ì¡°
  "recommend_session_id": "string",        // Aì™€ ë™ì¼í•œ Session ID

  "user_id": "string",
  "doc_id": "string",

  "selected_option_index": "int",          // ì„ íƒ ì•ˆí•˜ê³  ë‹«ìœ¼ë©´ null
  "was_accepted": "boolean",               // ìµœì¢… ì ìš© ì—¬ë¶€

  "created_at": "datetime",
  "correction_history_id": "string",       // D._id (Ground Truth ì—°ê²° ê³ ë¦¬)
  "paraphrase_llm_version": "string"
}
```

### ğŸŸ¦ D. correction_history (ê¸°ì¡´ Ground Truth ìŠ¤í‚¤ë§ˆ)

**ì„¤ëª…:** ê¸°ì—… ë ˆê±°ì‹œ ë°ì´í„° êµ¬ì¡° (ë³€ê²½ ì—†ìŒ).

```json
{
  "_id": "string",                         // ObjectID
  "user": "string|null",                   // User ID
  "field": "string",                       // Category Label
  "intensity": "string",                   // weak/moderate/strong
  "user_prompt": "string",                 // ìì—°ì–´ ì˜µì…˜ëª… (Phase 4 í•µì‹¬)
  "input_sentence": "string",
  "output_sentences": ["string"],
  "selected_index": "int|null",
  "created_at": "datetime"
}
```

### ğŸŸ¦ E. context_block (Micro Context ìŠ¤í‚¤ë§ˆ / Phase 1 í•µì‹¬)

**ì„¤ëª…:** ì„ íƒëœ êµ¬ê°„ì˜ ìœˆë„ìš°(Micro-Window) ë¬¸ë§¥ ë° ì„ë² ë”© ì›ì²œ ë°ì´í„°.

```json
{
  "context_hash": "string",        // PK: hash(doc_id + context_full)
  "doc_id": "string",
  "user_id": "string",

  "selected_text": "string",       // ë“œë˜ê·¸í•œ ì‹¤ì œ í…ìŠ¤íŠ¸
  "context_prev": "string",        // ì• ë¬¸ì¥ (Window)
  "context_next": "string",        // ë’¤ ë¬¸ì¥ (Window)

  "context_preview": "string",     // UIìš© ë¯¸ë¦¬ë³´ê¸°
  "context_full": "string",        // ì„ë² ë”©ìš© (prev + SEP + selected + SEP + next)

  "embedding_v1": ["number"],      // context_full ê¸°ë°˜ ì„ë² ë”© (Synthetic DBìš©)
  "embedding_version": "string",   
  "source": "string",              // "drag" or "auto"
  "created_at": "datetime"
}
```

### ğŸŸ¦ M. document_chunk (Vector DBìš© ìŠ¤í‚¤ë§ˆ / Phase 2+)

**ì„¤ëª…:** K.full_document_storeë¥¼ ì²­í¬ ë‹¨ìœ„ë¡œ ìª¼ê°œì–´ Vector DBì— ì €ì¥í•˜ëŠ” ìŠ¤í‚¤ë§ˆ.

```json
{
  "block_hash": "string",        // PK (doc_id + block_indexì˜ í•´ì‹œ)
  "doc_id": "string",
  "block_index": "int",
  "embedding_v1": ["number"],
  "embedding_version": "string",
  "created_at": "datetime"
}
```

### ğŸŸ¦ F. document_context_cache (Macro Context ìºì‹œ / Phase 1.5 í•µì‹¬)

**ì„¤ëª…:** LLMì´ ë¶„ì„í•œ ë¬¸ì„œ ì „ì²´ì˜ Context ì •ë³´ (Redis K-V Store).

```json
{
  "doc_id": "string",                      // PK

  "macro_topic": "string",                 // ë¬¸ì„œ ìš”ì•½ í† í”½
  "macro_category_hint": "string",         // ë¬¸ì„œ ê¸°ë°˜ ì¶”ì²œ íŒíŠ¸ (P_doc ê³„ì‚°ìš©)

  "cache_hit_count": "int",
  "last_updated": "datetime",
  "valid_until": "datetime",               // TTL (ì˜ˆ: 1ì‹œê°„)

  "invalidated_by_diff": "boolean",        // diff_ratio >= 10% íŠ¸ë¦¬ê±° ì—¬ë¶€
  "diff_ratio": "number",                  // ì§ì „ ë¶„ì„ ëŒ€ë¹„ ë³€ê²½ë¥  (0.0~1.0)

  "macro_llm_version": "string",
  "schema_version": "string"
}
```

### ğŸŸ¦ G. user_profile (Phase 2 í•µì‹¬ ì‚°ì¶œë¬¼)

**ì„¤ëª…:** ì‚¬ìš©ì í–‰ë™ ë°ì´í„° ì§‘ê³„ ë° ë²¡í„° í”„ë¡œí•„.

```json
{
  "user_id": "string",                     // PK

  "preferred_category_vector": ["number"], // length = #category
  "preferred_strength_vector": ["number"], // weak/moderate/strong dist.
  "preferred_language_vector": ["number"], // ko/en/jp dist.

  "recommend_accept_rate": "number",       // ì „ë°˜ì  ìˆ˜ìš©ë¥ 
  "paraphrase_execution_count": "int",
  "embedding_interaction_count": "int",

  "user_embedding_v1": ["number"],         // Behavior Embedding
  "updated_at": "datetime",

  "schema_version": "string",
  "cluster_id": "string"                   // Phase 3 Clustring ID
}
```

### ğŸŸ¦ H. training_examples (Phase 2 í•™ìŠµ ë°ì´í„°)

**ì„¤ëª…:** A~Fë¥¼ ì¡°ì¸í•˜ì—¬ ë§Œë“  ì§€ë„í•™ìŠµ(Supervised) ë°ì´í„°ì…‹.

```json
{
  "example_id": "string",                  // PK
  "recommend_session_id": "string",        // Consistency Group Key

  "user_id": "string",
  "doc_id": "string",

  // --- Features ---
  "context_embedding": ["number"],         // From E
  "macro_category_hint": "string|null",    // From F
  "reco_category_input": "string",         // From A
  "reco_scores_vec": { "category": "number" },
  "reco_scores_doc": { "category": "number|null" },

  // --- Actions ---
  "executed_target_language": "string|null",   // From B
  "executed_target_intensity": "string|null",  // From B
  "executed_target_category": "string|null",   // From B

  // --- Labels (Targets) ---
  "was_accepted": "boolean|null",              // From C
  "selected_option_index": "int|null",         // From C

  "groundtruth_field": "string|null",          // From D
  "groundtruth_intensity": "string|null",
  "groundtruth_user_prompt": "string|null",
  "groundtruth_selected_index": "int|null",

  // --- QA ---
  "consistency_flag": "string",                // "high" or "low" (v2.4 QA ê¸°ì¤€)
  "created_at": "datetime",
  "schema_version": "string"
}
```

### ğŸŸ¦ I. recommend_log (ì¶”ì²œ ë©”íŠ¸ë¦­ ë¶„ì„ìš©)

**ì„¤ëª…:** ìƒì„¸ ë””ë²„ê¹… ë° ë¶„ì„ì„ ìœ„í•œ ë¡œê·¸ (Aë³´ë‹¤ ë” ìƒì„¸í•œ ë¡œê¹… ê°€ëŠ¥).

```json
{
  "log_id": "string",
  "user_id": "string",
  "doc_id": "string",
  "recommend_session_id": "string",

  "P_vec": { "category": "number" },
  "P_rule": { "category": "number" },      // (v2.4 ì‹ ê·œ)
  "P_doc": { "category": "number" },
  "P_user": { "category": "number" },
  "P_cluster": { "category": "number" },

  "weight_vec": "number",
  "weight_rule": "number",                 // (v2.4 ì‹ ê·œ)
  "weight_doc": "number",
  "weight_user": "number",
  "weight_cluster": "number",

  "latency_ms": "number",
  "cache_hit_macro": "boolean",
  "cache_hit_user": "boolean",
  "cache_hit_cluster": "boolean",

  "model_version": "string",
  "api_version": "string",
  "schema_version": "string",

  "created_at": "datetime"
}
```
Phase 1ì—ì„œëŠ” P_doc, P_user, P_cluster í•„ë“œì— {} (empty dict)ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤. (nullì´ ì•„ë‹˜)
Phase 1.5ë¶€í„° í•„ë“œ ìƒì„±


### ğŸŸ¦ J. cluster_profile (Phase 3 ì‹ ê·œ ìŠ¤í‚¤ë§ˆ)

**ì„¤ëª…:** ìœ ì‚¬ ì‚¬ìš©ì ê·¸ë£¹(Cluster) í”„ë¡œí•„.

```json
{
  "cluster_id": "string",                      // PK
  "centroid_embedding": ["number"],
  "category_vector":  ["number"],
  "strength_vector":  ["number"],
  "language_vector":  ["number"],
  "user_count": "int",
  "last_updated": "datetime",
  "schema_version": "string"
}
```

### ğŸŸ¦ K. full_document_store (Phase 1.5 Macro ì›ë³¸)

**ì„¤ëª…:** ë¬¸ì„œ ì „ì²´ í…ìŠ¤íŠ¸ ë° ë³€ê²½ì‚¬í•­ ì €ì¥ì†Œ.

```json
{
  "doc_id": "string",                          // PK

  "blocks": [
    { "block_index": "int", "text": "string" }
  ],

  "latest_full_text": "string",
  "previous_full_text": "string|null",

  "diff_ratio": "number",                      // ETL íŠ¸ë¦¬ê±° ê¸°ì¤€
  "last_synced_at": "datetime",
  "schema_version": "string"
}
```
diff_ratio ê³„ì‚° ê³µì‹ (ì •ì˜ ì¶”ê°€)

ê¸°ë³¸ ë°©ì‹:
diff_ratio = levenshtein_distance(prev_full_text, full_text) / max(len(prev_full_text), 1)

ë‹¨, ë¸”ë¡ ë‹¨ìœ„ ë³€ê²½ë„ ê°ì§€í•´ì•¼ í•˜ë¯€ë¡œ ë‹¤ìŒ ë³´ì¡° ê¸°ì¤€ ì‚¬ìš©:

- block_add_ratio = (ì¶”ê°€ëœ block ìˆ˜) / (ì „ì²´ block ìˆ˜)
- block_del_ratio = (ì‚­ì œëœ block ìˆ˜) / (ì „ì²´ block ìˆ˜)

ìµœì¢… diff_ratioëŠ” ë‹¤ìŒ ì¤‘ ìµœëŒ€ê°’ì„ ì‚¬ìš©í•œë‹¤:
diff_ratio = max(
    text_diff_ratio,
    block_add_ratio,
    block_del_ratio
)
text_diff_ratio = levenshtein(prev_full_text, full_text) / max(len(prev_full_text), 1)

block_add_ratio = (#added_blocks) / total_blocks
block_del_ratio = (#deleted_blocks) / total_blocks

diff_ratio = max(text_diff_ratio, block_add_ratio, block_del_ratio)


### ğŸŸ¦ L. editor_document_snapshot (FE ì „ì†¡ìš© ì´ë²¤íŠ¸)

**ì„¤ëª…:** FEì—ì„œ ì €ì¥ ì‹œì ì— ë³´ë‚´ëŠ” ìŠ¤ëƒ…ìƒ·/Diff ë°ì´í„°.

```json
{
  "snapshot_id": "string",         // PK, UUID
  "doc_id": "string",
  "user_id": "string",

  "blocks": [
    { "block_index": "int", "text": "string" }
  ],
  "full_text": "string",           // ì „ì²´ í…ìŠ¤íŠ¸
  
  // prev_full_textëŠ” FEê°€ ë³´ë‚´ì§€ ì•ŠìŒ (ì„œë²„ì—ì„œ K ì¡°íšŒ í›„ ì±„ì›€)
  "full_text": "string",           // ì „ì²´ ë¬¸ì„œ í•©ì³ì§„ í…ìŠ¤íŠ¸
  "prev_full_text": "string|null", // ë°”ë¡œ ì§ì „ ìŠ¤ëƒ…ìƒ·ì—ì„œ ê°€ì ¸ì˜´ (ì„œë²„ ì¸¡)

  
  "cursor_position": "int|null",
  "snapshot_version": "string",
  "created_at": "datetime"
}
```

-----

# ğŸ“Š Diff Report: v2.3 vs v2.4 ìŠ¤í‚¤ë§ˆ ë³€ê²½ì 

ì‚¬ìš©ìë¶„ì˜ ì§ˆë¬¸ì— ëª…í™•íˆ ë‹µë³€ë“œë¦¬ê¸° ìœ„í•´ ë³€ê²½ëœ ì§€ì ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.

| ìŠ¤í‚¤ë§ˆ (Collection) | ë³€ê²½ í•„ë“œ | ë³€ê²½ ì‚¬ìœ  (Reason) |
| :--- | :--- | :--- |
| **A. editor_reco_options** | `P_rule` (Add) | Phase 1 ë¡œì§ì´ **Rule + Vector í•˜ì´ë¸Œë¦¬ë“œ**ë¡œ ë³€ê²½ë¨ì— ë”°ë¼ Rule ì ìˆ˜ ì €ì¥ í•„ìš”. |
| | `weight_rule` (Add) | Rule ì—”ì§„ì˜ ë°˜ì˜ ë¹„ì¤‘ ì €ì¥. |
| | `doc_maturity_score` (Add) | Phase 1.5ì˜ **ë¬¸ì„œ ê¸¸ì´ ê¸°ë°˜ ë™ì  ê°€ì¤‘ì¹˜($	ext{	extalpha}$)** ê³„ì‚° ê²°ê³¼ ì €ì¥. |
| **I. recommend_log** | `P_rule`, `weight_rule` (Add) | ì¶”ì²œ ë©”íŠ¸ë¦­ ë¶„ì„ ì‹œ Rule ì—”ì§„ì˜ ê¸°ì—¬ë„ì™€ Latency ì˜í–¥ ë¶„ì„ í•„ìš”. |
| **H. training_examples** | `consistency_flag` (Emphasis) | v2.4ì—ì„œ **Session Consistency Rule**ì´ ê°•í™”ë¨ì— ë”°ë¼, ë°ì´í„° í’ˆì§ˆ ë“±ê¸‰(High/Low)ì„ ëª…ì‹œì ìœ¼ë¡œ ë§ˆí‚¹. |
| **K. full_document_store** | `diff_ratio` Formula (Define) | v2.4 ëª…ì„¸ì—ì„œ `diff_ratio` ê³„ì‚° ë¡œì§(Levenshtein + Block Diff Max)ì´ êµ¬ì²´í™”ë¨. |

**ê²°ë¡ :**
ê¸°ì¡´ v2.3ì˜ êµ¬ì¡°ë¥¼ **100% ìœ ì§€**í•˜ë©´ì„œ, v2.4ì˜ í•µì‹¬ ë¡œì§ì¸ **"Rule Engine ë„ì…"**ê³¼ **"ë™ì  ê°€ì¤‘ì¹˜(Maturity)"**ë¥¼ ì§€ì›í•˜ê¸° ìœ„í•œ í•„ë“œë§Œ ì •ë°€í•˜ê²Œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ v2.3 ë°ì´í„°ë¥¼ v2.4ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•  ë•Œ ë°ì´í„° ì†ì‹¤ì€ ì—†ìŠµë‹ˆë‹¤.
-----

ğŸ“˜ PART 4 â€” íŠ¸ëœì­ì…˜ ì „ì²´ ìš”ì•½ (v2.4)

**4.1 ì „ì²´ íë¦„**

1.  **ì¶”ì²œ(A):** APIê°€ $P_{	ext{vec}}, P_{	ext{rule}}, P_{	ext{doc}}$(ì˜µì…˜), $P_{	ext{user}}$(ì˜µì…˜)ë¥¼ ê²°í•©í•˜ì—¬ $P_{	ext{final}}$ ê³„ì‚° í›„ ë°˜í™˜.
2.  **ë¹„ë™ê¸° ì €ì¥:** A/I/E ë¡œê·¸ë¥¼ Kafka â†’ MongoDB ì ì¬.
3.  **ë¬¸ì„œ ì €ì¥(K):** `editor_document_snapshot` â†’ Diff ê³„ì‚° â†’ K ì—…ë°ì´íŠ¸.
4.  **ì‹¤í–‰(B):** ì‚¬ìš©ì ì‹¤í–‰ ì‹œ B ë¡œê·¸ ì €ì¥. (D ìƒì„± ì•ˆ í•¨)
5.  **ì„ íƒ(C) & ì •ë‹µ(D):** ì‚¬ìš©ì ì„ íƒ ì‹œ C ì €ì¥ â†’ D ìƒì„± â†’ Cì— `correction_history_id` ì—…ë°ì´íŠ¸.
6.  **Macro ETL(F):** Kì˜ Diff 10% ì´ìƒ ì‹œ LLM ë¶„ì„ í›„ F ìºì‹œ ê°±ì‹ .
7.  **User Profile ETL(G):** B/C/D ë¡œê·¸ ì§‘ê³„í•˜ì—¬ G ìºì‹œ ê°±ì‹ .
8.  **í•™ìŠµ ë°ì´í„°(H):** ëª¨ë“  ë¡œê·¸ ì¡°ì¸í•˜ì—¬ í•™ìŠµì…‹ ìƒì„±.

**4.2 Consistency Rule**

  * A/B/CëŠ” `recommend_session_id` ê³µìœ .
  * DëŠ” `correction_history_id`ë¡œ Cì™€ ì—°ê²°.
  * B/CëŠ” Aì˜ `insert_id`ë¥¼ `source_recommend_event_id`ë¡œ ì°¸ì¡°.

-----

# ğŸ“˜ PART 5 â€” Future Scalability & Advanced Architecture

## 5-1. ì‹¤ì‹œê°„ ETL ê³ ë„í™” (Stream Join)

í˜„ì¬(Phase 2.5) ì•„í‚¤í…ì²˜ëŠ” **MongoDB ê¸°ë°˜ì˜ ë°°ì¹˜(Batch) ETL**ì„ í†µí•´ í•™ìŠµ ë°ì´í„°(H)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì´ëŠ” êµ¬í˜„ì´ ìš©ì´í•˜ê³  ë°ì´í„° ì •í•©ì„± ê´€ë¦¬(ìˆ˜ì •/ì¬ì§‘ê³„)ì— ìœ ë¦¬í•˜ì§€ë§Œ, ë°ì´í„° ë°˜ì˜ì— **ìˆ˜ ë¶„ì˜ ì‹œì°¨(Lag)**ê°€ ë°œìƒí•©ë‹ˆë‹¤.

í–¥í›„ íŠ¸ë˜í”½ì´ í­ì¦í•˜ê±°ë‚˜ **ì´ˆì‹¤ì‹œê°„(Sub-second) ê°œì¸í™”**ê°€ í•„ìš”í•´ì§ˆ ê²½ìš°, ë‹¤ìŒê³¼ ê°™ì´ ì•„í‚¤í…ì²˜ë¥¼ ê³ ë„í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ğŸŒŠ Kafka Streams / Flink ë„ì… (Event-Driven ETL)

*   **ê°œë…:** `A`, `B`, `C` ì´ë²¤íŠ¸ë¥¼ DBì— ì €ì¥í•˜ì§€ ì•Šê³ , **Kafka ë ˆë²¨ì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¡°ì¸(Stream Join)**í•˜ì—¬ ì¦‰ì‹œ `H` ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ëŠ” ë°©ì‹.
*   **êµ¬ì„±:**
    *   **Windowing:** `session_id`ë¥¼ í‚¤ë¡œ í•˜ì—¬ ì¼ì • ì‹œê°„(ì˜ˆ: 30ë¶„) ë™ì•ˆì˜ ìœˆë„ìš°ë¥¼ ìœ ì§€.
    *   **State Store:** ë„ì°©í•œ ì´ë²¤íŠ¸ë¥¼ ë¡œì»¬ RocksDB ë“±ì— ì„ì‹œ ì €ì¥.
    *   **Join:** A+B+Cê°€ ëª¨ë‘ ë„ì°©í•˜ë©´ ì¦‰ì‹œ `TrainingExample` ê°ì²´ ìƒì„± í›„ `golden_data_topic`ìœ¼ë¡œ ë°œí–‰.
*   **ì¥ì :**
    *   **Zero Latency:** ì‚¬ìš©ìê°€ ìˆ˜ë½(C)í•˜ëŠ” ì¦‰ì‹œ ëª¨ë¸ í•™ìŠµ/í”„ë¡œí•„ ê°±ì‹  ê°€ëŠ¥.
    *   **DB ë¶€í•˜ ê°ì†Œ:** MongoDB ì½ê¸°/ì“°ê¸° ì‘ì—… ì œê±°.
*   **ë‹¨ì  (Trade-off):**
    *   **ë³µì¡ì„±:** ë¶„ì‚° ì‹œìŠ¤í…œì˜ ìƒíƒœ ê´€ë¦¬, ìœˆë„ìš° ì²˜ë¦¬, ìˆœì„œ ë³´ì¥ ë“± êµ¬í˜„ ë‚œì´ë„ ê¸‰ìƒìŠ¹.
    *   **ìš´ì˜ ë¹„ìš©:** Kafka Streams/Flink í´ëŸ¬ìŠ¤í„° ìš´ì˜ ë¦¬ì†ŒìŠ¤ í•„ìš”.
    *   **ìœ ì—°ì„± ì €í•˜:** ê³¼ê±° ë°ì´í„° ì¬ì²˜ë¦¬(Replay)ë‚˜ ë¡œì§ ìˆ˜ì •ì´ ë°°ì¹˜ ë°©ì‹ë³´ë‹¤ ê¹Œë‹¤ë¡œì›€.

> **ê²°ë¡ :** í˜„ì¬ MVP ë‹¨ê³„ì—ì„œëŠ” **ì•ˆì •ì„±ê³¼ ìœ ì—°ì„±ì´ ë†’ì€ Batch ETL**ì„ ìœ ì§€í•˜ê³ , ì‹œìŠ¤í…œ ì„±ìˆ™ë„ê°€ ë†’ì•„ì§€ëŠ” Phase 4 ì´í›„ì— ë„ì…ì„ ê²€í† í•œë‹¤.

## 5-2. LLM Response Caching ê³ ë„í™” (Future Plan)

í˜„ì¬(v2.4) êµ¬í˜„ëœ LLM Response CacheëŠ” `selected_text`ì˜ **Level 1 ì •ê·œí™”(ì–‘ë ê³µë°±/êµ¬ë‘ì  ì œê±°)**ë§Œì„ ì ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì¶”í›„ ë¹„ìš© ìµœì í™”ì™€ ì‚¬ìš©ì ê²½í—˜ ê°œì„ ì„ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ê³ ë„í™” ë°©ì•ˆì„ ê³ ë ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ğŸ§¬ Fuzzy Matching & Semantic Caching

*   **Level 2 ì •ê·œí™” (Aggressive Normalization):**
    *   ëª¨ë“  ê³µë°± ì œê±° (`"ì•ˆ ë…•"` == `"ì•ˆë…•"`)
    *   íŠ¹ìˆ˜ë¬¸ì ì œê±° (`"ì•ˆë…•!"` == `"ì•ˆë…•"`)
*   **Vector Similarity Cache (Semantic Cache):**
    *   `Redis` ëŒ€ì‹  `Vector DB`ë¥¼ ìºì‹œ ì €ì¥ì†Œë¡œ í™œìš©.
    *   ìš”ì²­ í…ìŠ¤íŠ¸ì˜ ì„ë² ë”©ì„ ìƒì„±í•˜ê³ , ê¸°ì¡´ ìºì‹œëœ í‚¤ë“¤ê³¼ì˜ **ì½”ì‚¬ì¸ ìœ ì‚¬ë„**ë¥¼ ê³„ì‚°.
    *   ìœ ì‚¬ë„ê°€ 0.95 ì´ìƒì¸ ê²½ìš°(ì˜ë¯¸ì ìœ¼ë¡œ ë™ì¼í•œ ë¬¸ì¥) ìºì‹œëœ ê²°ê³¼ë¥¼ ë°˜í™˜.
    *   **ì¥ì :** "ë°°ê³ íŒŒ"ì™€ "ë‚˜ ë°°ê³ íŒŒ" ê°™ì€ ìœ ì‚¬ ë¬¸ì¥ë„ ìºì‹œ Hit ê°€ëŠ¥.
    *   **ë‹¨ì :** ì„ë² ë”© ìƒì„± ë¹„ìš© ë° ê²€ìƒ‰ Latency ë°œìƒ (Trade-off ê³ ë ¤ í•„ìš”).

> **Note:** ì´ ê¸°ëŠ¥ì€ íŠ¸ë˜í”½ ë¹„ìš© ë¶„ì„ í›„ Phase 4 ì´í›„ ë„ì…ì„ ê²€í† í•©ë‹ˆë‹¤.