# ì•„í‚¤í…ì²˜, ë°ì´í„°ìŠ¤í‚¤ë§ˆ, íŠ¸ëœì­ì…˜

> **[ì°¸ê³ ] `P_rule` ë³€ê²½ ì´ë ¥**
>
> ì´ˆê¸° Phase 1 ê¸°íš ë‹¹ì‹œì—ëŠ” `P_rule`(ê·œì¹™ ê¸°ë°˜ ì ìˆ˜)ê³¼ `P_vec`(ë²¡í„° ê¸°ë°˜ ì ìˆ˜)ë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ëª©í‘œì˜€ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì‹œìŠ¤í…œ ê²½ëŸ‰í™”ë¥¼ ìœ„í•´ `P_rule`ì´ ì ì •ì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì´í›„ Phase 2 ê°œë°œ ê³¼ì •ì—ì„œ íŠ¹ì • ë„ë©”ì¸ ì§€ì‹ì„ ë°˜ì˜í•  í•„ìš”ì„±ì´ ë‹¤ì‹œ ì œê¸°ë˜ì–´, í˜„ì¬ ì•„í‚¤í…ì²˜(v2.4)ì—ëŠ” `P_rule`ì´ ë‹¤ì‹œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ë¬¸ì„œëŠ” `P_rule`ì´ í¬í•¨ëœ ìµœì‹  êµ¬ì¡°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.

ğŸ“˜ PART 1 â€” ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜


(ì´ì „ v2.3)

ë³¸ ì ˆì€ ë¬¸ì¥êµì • ì¶”ì²œ ì‹œìŠ¤í…œì˜ ì „ì²´ ê¸°ìˆ  êµ¬ì¡°ë¥¼ ì‹¤ì‹œê°„ ê²½ë¡œ(Real-time Path), ì €ì¥ì†Œ(Storage), ë°°ì¹˜ ê²½ë¡œ(Offline Path) ì„¸ ê´€ì ì—ì„œ í‘œí˜„í•œë‹¤.
ì´ ì•„í‚¤í…ì²˜ëŠ” Phase 1~4 ì „ì²´ ê¸°ëŠ¥ì„ í¬í•¨í•˜ë©°, ê° Phaseì—ì„œ ìƒì„±Â·í™œìš©ë˜ëŠ” ëª¨ë“  ë°ì´í„° ìš”ì†Œ(A~I ìŠ¤í‚¤ë§ˆ), ê·¸ë¦¬ê³  ë…ë¦½ì ì¸ ì»¨í…ìŠ¤íŠ¸ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸(E: Micro / Kâ†’F: Macro)ì„ ëª…í™•íˆ ë¶„ë¦¬í•œ ìµœì¢… êµ¬ì¡°ë‹¤.
ì•„ë˜ ë‹¤ì´ì–´ê·¸ë¨ì€ ì‚¬ìš©ì ì…ë ¥ â†’ ì¶”ì²œ API â†’ ë¹„ë™ê¸° ë¡œê·¸ ì²˜ë¦¬ â†’ ETL íŒŒì´í”„ë¼ì¸ â†’ ìºì‹œ/DB â†’ ë‹¤ì‹œ APIë¡œ ì´ì–´ì§€ëŠ” íì‡„ ë£¨í”„ë¥¼ ì™„ì „í•œ í˜•íƒœë¡œ í‘œí˜„í•œë‹¤.

1-1 ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ (v2.4)
ë³¸ ì ˆì€ ë¬¸ì¥êµì • ì¶”ì²œ ì‹œìŠ¤í…œì˜ ì „ì²´ ê¸°ìˆ  êµ¬ì¡°ë¥¼ ì‹¤ì‹œê°„ ê²½ë¡œ(Real-time Path), ì €ì¥ì†Œ(Storage), ë°°ì¹˜ ê²½ë¡œ(Offline Path) ì„¸ ê´€ì ì—ì„œ í‘œí˜„í•œë‹¤.
ì´ ì•„í‚¤í…ì²˜ëŠ” Phase 1~4 ì „ì²´ ê¸°ëŠ¥ì„ í¬í•¨í•˜ë©°, ê° Phaseì—ì„œ ìƒì„±Â·í™œìš©ë˜ëŠ” ëª¨ë“  ë°ì´í„° ìš”ì†Œ(A~I ìŠ¤í‚¤ë§ˆ), ê·¸ë¦¬ê³  ë…ë¦½ì ì¸ ì»¨í…ìŠ¤íŠ¸ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸(E: Micro / Kâ†’F: Macro)ì„ ëª…í™•íˆ ë¶„ë¦¬í•œ ìµœì¢… êµ¬ì¡°ë‹¤.
íŠ¹íˆ v2.4ì—ì„œëŠ” ì´ˆê¸° êµ¬ì¶• íš¨ìœ¨ì„±ì„ ìœ„í•´ ë³µì¡í•œ ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤(BigQuery) ëŒ€ì‹  MongoDBë¥¼ í†µí•© ë¡œê·¸ ì €ì¥ì†Œë¡œ í™œìš©í•˜ë©°, Streamlit Sidecar íŒ¨í„´ì„ í†µí•´ ì‹¤ì‹œê°„ ë°ì´í„° ê°€ì‹œì„±ì„ í™•ë³´í•œë‹¤.

ğŸ§­ 1-1. ì‹œìŠ¤í…œ ì „ì²´ êµ¬ì¡° (Real-time + Offline + Storage)
ğŸ’¡ ìƒˆë¡­ê²Œ ë°˜ì˜ëœ í•µì‹¬ ì‚¬í•­ (v2.4 ì—…ë°ì´íŠ¸)
Log Store ìµœì í™” (BigQuery â†’ MongoDB): ëª¨ë“  ì´ë²¤íŠ¸ ë¡œê·¸(A~I)ë¥¼ Kafka Consumerê°€ Micro-Batch ë°©ì‹ìœ¼ë¡œ MongoDBì— ì§ì ‘ ì ì¬í•œë‹¤. (ë³µì¡í•œ ETL ì œê±°)
Smart Ingester (Kafka Consumer): Consumerê°€ ë‹¨ìˆœ ìˆ˜ì‹ ì„ ë„˜ì–´ ë°ì´í„° ì •ì œ, í¬ë§·íŒ…, ë°°ì¹˜ ì €ì¥ì„ ìˆ˜í–‰í•˜ëŠ” ê²½ëŸ‰ ETL ì›Œì»¤ ì—­í• ì„ ê²¸í•œë‹¤.
Sidecar Dashboard (Streamlit): ë³„ë„ì˜ ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì—†ì´, MongoDBì™€ Redisë¥¼ Read-Onlyë¡œ ì§ì ‘ ì¡°íšŒí•˜ì—¬ ì‹¤ì‹œê°„ ì§€í‘œë¥¼ ì‹œê°í™”í•œë‹¤.
Adaptive Scoring & Macro ETL: v2.3ì˜ ë™ì  ê°€ì¤‘ì¹˜($\alpha$) ë° ë¬¸ì„œ ë¶„ì„ íŒŒì´í”„ë¼ì¸ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•œë‹¤.
ğŸ’¡ ìƒˆë¡­ê²Œ ë°˜ì˜ëœ í•µì‹¬ ì‚¬í•­ (v2.3 ì—…ë°ì´íŠ¸)

Rule Engine ($P_{rule}$) ì˜êµ¬ ì‚­ì œ: ë²¡í„° ê²€ìƒ‰($P_{vec}$) ì¤‘ì‹¬ìœ¼ë¡œ ì‹œìŠ¤í…œ ê²½ëŸ‰í™” ë° ìœ ì§€ë³´ìˆ˜ íš¨ìœ¨ì„± ì¦ëŒ€.
ì‹ ë¢°ë„ ê¸°ë°˜ ì ì‘í˜• ìŠ¤ì½”ì–´ë§ (Adaptive Scoring): ë¬¸ì„œ ì„±ìˆ™ë„(ê¸¸ì´)ì— ë”°ë¼ Macro($P_{doc}$) ê°€ì¤‘ì¹˜($\alpha$)ë¥¼ ë™ì ìœ¼ë¡œ ì¡°ì ˆ.
Full-Logging êµ¬ì¡°: ìµœì¢… ì ìˆ˜ì— ë°˜ì˜ë˜ì§€ ì•ŠëŠ” ìš”ì†Œ($P_{doc}$ ë“±)ë¼ë„ ê³„ì‚°ëœ ê°’ê³¼ ê°€ì¤‘ì¹˜ëŠ” ë°˜ë“œì‹œ ë¡œê·¸(I)ì— ë‚¨ê²¨ ì¶”í›„ ì‹œë®¬ë ˆì´ì…˜(Shadowing)ì´ ê°€ëŠ¥í•˜ë„ë¡ í•¨.
Macro ContextëŠ” ë°˜ë“œì‹œ K.full_document_store â†’ F.document_context_cache ê²½ë¡œë¡œë§Œ ìƒì„±ë¨ (Eì™€ ì™„ì „ ë¶„ë¦¬).
P_user, P_cluster ì¡°íšŒëŠ” Phase 3 ì´ìƒì—ì„œë§Œ í™œì„±í™”.
editor_document_snapshot â†’ K ì €ì¥ â†’ diff ê¸°ë°˜ ìºì‹œ ë¬´íš¨í™” ê·œì¹™(>=10%) ì¶”ê°€.
A/B/Cë§Œ recommend_session_idë¥¼ ê³µìœ í•˜ë©° D(correction_history)ëŠ” correction_history_idë¡œë§Œ ì—°ê²°ëœë‹¤.
F/G/J ìºì‹œëŠ” ëª¨ë‘ Redisì— ì €ì¥í•˜ë©° TTL/invalidated_by_diff/last_updatedë¥¼ ìƒì„¸ ê´€ë¦¬.

1-2. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨


ì½”ë“œ ìŠ¤ë‹ˆí«


graph TD
  subgraph "ì‹¤ì‹œê°„ ê²½ë¡œ (Real-time Path)"
      direction LR

      User(ì‚¬ìš©ì) -- "1. ì¶”ì²œ ìš”ì²­ (HTTPS)\n(doc_id, context_text, user_id)" --> FE["í”„ë¡ íŠ¸ì—”ë“œ<br>(ì›¹ ì—ë””í„°)"]

      %% Phaseë³„ ì¡°íšŒ ë°˜ì˜
      FE -- "2. /recommend API í˜¸ì¶œ\n(P_vec / P_doc? / P_user? / P_cluster?)" --> API["ì¶”ì²œ API ì„œë²„"]

      %% ìºì‹œ ê³„ì¸µ: 1.5(F), 2(G), 3(J)
      API -- "3. Macro ì¡°íšŒ (Phase1.5+)\nF.document_context_cache(doc_id)" --> CacheF["F ë§¤í¬ë¡œ ìºì‹œ\n(Redis)"]
      API -- "4. User Profile ì¡°íšŒ (Phase2+)\nG.user_profile(user_id)" --> CacheG["G í”„ë¡œí•„ ìºì‹œ\n(Redis)"]
      API -- "5. Cluster Profile ì¡°íšŒ (Phase3+)\nkey = G.user_profile.cluster_id" --> CacheJ["J í´ëŸ¬ìŠ¤í„° ìºì‹œ\n(Redis)"]

			API --> EmbeddingModel(Micro-Window ì„ë² ë”©)
			API --> ParaphrasingLLM(ì‹¤í–‰-B ë‹¨ê³„)
			ETL --> MacroLLM(Kâ†’F ë¶„ì„)

      API -- "6. Vector Search (Phase1+)\nE.context_block(context_hash)" --> VDB["E ë¬¸ë§¥ VectorDB"]

      API -- "7. P_final ê³„ì‚°\n(1-Î±)P_vec + Î±P_doc + P_user + P_cluster" --> API

      API -- "8. ì¶”ì²œ ê²°ê³¼ ë°˜í™˜\n(insert_id, ì¶”ì²œ ì˜µì…˜)" --> FE
      FE -- "9. ì‚¬ìš©ìì—ê²Œ ì¶”ì²œ ì˜µì…˜ í‘œì‹œ" --> User

      API -- "10. ë¹„ë™ê¸° ì´ë²¤íŠ¸ ë°œí–‰\n(editor_recommend_options, recommend_log)" --> MQ["ë©”ì‹œì§€ í\n(Kafka)"]

      User -- "11. ë¬¸ì„œ ì €ì¥/íƒ€ì´í•‘" --> FE
      FE -- "12. editor_document_snapshot ë°œí–‰" --> MQ
  end

  %% Storage Layer (Unified MongoDB)
  subgraph "ë°ì´í„° ì €ì¥ì†Œ (Unified Storage - MongoDB)"
      MQ -- "13. Smart Consumer (Micro-Batch)" --> Consumer["Kafka Consumer\n(Ingester Worker)"]
      
      Consumer -- "14. ë¡œê·¸ ì ì¬ (A/B/C/I)" --> MongoLogs["ë¡œê·¸ ì»¬ë ‰ì…˜\n(log_a, log_b, log_i...)"]
      Consumer -- "15. ë¬¸ì„œ ì›ë³¸ ì €ì¥ (K)" --> MongoDocs["ë¬¸ì„œ ì»¬ë ‰ì…˜\n(full_document_store)"]
      
      Consumer -- "16. Micro Context (E)" --> ContextDB["E ë¬¸ë§¥ DB (Vector Store)"]
      
      FE -- "17. Ground Truth (D)" --> MongoLogs
  end

  %% Offline Path & Analytics
  subgraph "ë¶„ì„ ë° ì‹œê°í™” (Analytics)"
      ETL["ETL íŒŒì´í”„ë¼ì¸ (Python Script)"]

      %% Macro Context ë°°ì¹˜
      MongoDocs -- "18a. ë¬¸ì„œ ì›ë³¸ ì½ê¸° (Diff Check)" --> ETL
      ETL -- "19a. LLM ë¶„ì„ â†’ Macro ìºì‹œ ìƒì„±" --> CacheF

      %% Dashboard (Sidecar)
      MongoLogs -- "20. ì‹¤ì‹œê°„ ì§€í‘œ ì¡°íšŒ" --> Dashboard["ğŸ“Š ëŒ€ì‹œë³´ë“œ (Streamlit)\n(Sidecar Container)"]
      MongoDocs -- "21. ë¬¸ì„œ/í–‰ë™ ë¶„ì„" --> Dashboard
      CacheF -- "22. ìºì‹œ ìƒíƒœ ëª¨ë‹ˆí„°ë§" --> Dashboard
      
      %% User Profile
      MongoLogs -- "23. ë¡œê·¸ ì§‘ê³„" --> ETL
      ETL -- "24. user_profile(G) ìƒì„±" --> CacheG
  end

  style CacheF fill:#fff2cc
  style CacheG fill:#fff2cc
  style CacheJ fill:#fff2cc
  style User fill:#cde4ff
  style FE fill:#cde4ff
  style API fill:#cde4ff
  style ETL fill:#d5e8d4
  style Dashboard fill:#ffe6cc





1-3. Real-time Path ìƒì„¸ ì„¤ëª…


(1) ì¶”ì²œ ìš”ì²­ (User â†’ FE â†’ API)

â€¢ FEëŠ” ë‹¤ìŒ ì •ë³´ë¥¼ APIë¡œ ì „ì†¡í•œë‹¤:
doc_iduser_idselected_textcontext: { "prev": "...", "next": "..." }
(context_hashì™€ context_textëŠ” FEê°€ ì•„ë‹Œ ë°±ì—”ë“œ API ì„œë²„ê°€ ìƒì„±/ê³„ì‚°í•¨)
ì´ ìš”ì²­ì´ ì¶”ì²œ íŠ¸ëœì­ì…˜(A)ì˜ ì‹œì‘ì ì´ ëœë‹¤.
recommend_session_idëŠ” í•­ìƒ API ì„œë²„ê°€ ìƒì„±í•œë‹¤.
FEëŠ” ì‚¬ìš©ì ë“œë˜ê·¸ ì‹œ session_idë¥¼ ìƒì„±í•˜ì§€ ì•Šìœ¼ë©°,
API ì‘ë‹µì„ ë°›ì€ ì´í›„ B/C ì´ë²¤íŠ¸ì— session_idë¥¼ í¬í•¨í•˜ì—¬ ì „ì†¡í•œë‹¤.

(2) ì¶”ì²œ API ë‚´ë¶€ ë¡œì§ êµ¬ì„±

APIëŠ” Phaseì— ë”°ë¼ ë‹¤ìŒ ìš”ì†Œë¥¼ ì¡°íšŒí•œë‹¤:
Phase
ì‚¬ìš©ë˜ëŠ” ìš”ì†Œ
ì¶œì²˜
1.0
P_vec
context_block(E)
1.5
+ P_doc
document_context_cache(F)
2.0
+ user_profile ê¸°ë°˜ feature
user_profile(G)
3.0
+ P_user, + P_cluster
G(user_profile), J(cluster_profile)
4.0
+ style/tone generator
ëª¨ë“  ë°ì´í„° ê¸°ë°˜


(3) Vector Search (P_vec) â€” E.context_block ê¸°ë°˜

context_hashë¥¼ keyë¡œ Eì—ì„œ embeddingì„ ê°€ì ¸ì˜¤ê±°ë‚˜
context_textë¥¼ ì¦‰ì„ ì„ë² ë”©í•˜ì—¬ KNN ê²€ìƒ‰ ìˆ˜í–‰
context_textëŠ” EmbeddingModel(embedding_v1)ë¡œ ì„ë² ë”©ì„ ìƒì„±í•œ ë’¤,
í•´ë‹¹ ë²¡í„°ë¡œ VectorDB(KNN) ê²€ìƒ‰ì„ ìˆ˜í–‰í•œë‹¤.
ëª¨ë“  ì„ë² ë”©ì€ embedding_versionì„ í¬í•¨í•´ì•¼ í•œë‹¤.
EëŠ” Microì˜ ì „ìš© ì €ì¥ì†Œì´ë©° Macro(Kâ†’F)ì™€ ì—°ê²°ë˜ì§€ ì•ŠìŒ.

(4) Macro Context ì¡°íšŒ (P_doc) â€” F.document_context_cache

ì¡°íšŒ í‚¤: doc_id
ë°˜í™˜ ê°’:
macro_category_hint
macro_topic
cache_hit
last_updated, valid_until
Cache ë¬´íš¨í™” ì¡°ê±´ (v2.2):
TTL ë§Œë£Œ
ë˜ëŠ” diff_ratio >= 10% (ì¦‰ê° ë¬´íš¨í™” ë° ì¬ê³„ì‚° ìš”ì²­)

(5) User Profile ì¡°íšŒ (P_user) â€” G.user_profile

ì¡°íšŒ í‚¤: user_id
ë°˜í™˜ ê°’:
preferred_category_vector
preferred_strength_vector
preferred_language_vector
recommend_accept_rate
user_embedding_v1

(6) Cluster Profile ì¡°íšŒ (P_cluster) â€” J.cluster_profile

ì¡°íšŒ í‚¤: cluster_id
ë°˜í™˜ ê°’:
centroid_embedding
ì¹´í…Œê³ ë¦¬Â·ê°•ë„Â·ì–¸ì–´ ë¶„í¬ ë²¡í„°
last_updated
cluster_idëŠ” user_profile(G)ì— ì €ì¥ëœ ê°’ì´ë©°
APIëŠ” ë¨¼ì € user_profileì„ ì¡°íšŒí•œ ë’¤ cluster_idë¥¼ ì–»ëŠ”ë‹¤.
ê·¸ í›„ cluster_profile(J)ë¥¼ ì¡°íšŒí•œë‹¤.

(7) ìµœì¢… ì ìˆ˜ ê³„ì‚° (P_final)




# v2.3 ë³€ê²½: ë™ì  ê°€ì¤‘ì¹˜ ì ìš©
# alpha = f(doc_length) (ë¬¸ì„œ ì„±ìˆ™ë„)

P_final = (1 - alpha) * P_vec
        + alpha * P_doc
        + w_user * P_user
        + w_cluster * P_cluster



Phase 1.5 ì´ˆê¸°ë‚˜ í…ŒìŠ¤íŠ¸ ì‹œ alphaë¥¼ 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´, $P_{doc}$ì€ ê³„ì‚°ë˜ì§€ë§Œ $P_{final}$ì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤. (Shadow Effect)
ëª¨ë“  ê³„ì‚°ëœ ì ìˆ˜ì™€ ê°€ì¤‘ì¹˜ëŠ” **recommend_log(I)**ì— ê¸°ë¡ë˜ì–´ì•¼ í•œë‹¤.

(8) ë¹„ë™ê¸° ë°ì´í„° ì €ì¥

APIëŠ” ê²°ê³¼ë¥¼ FEë¡œ ë°˜í™˜í•œ ë’¤,
ë¹„ë™ê¸° íë¥¼ í†µí•´ A, I, Eë¥¼ ì €ì¥í•œë‹¤.
A: editor_recommend_options
I: recommend_log
E: context_block
K: editor_document_snapshot â†’ full_document_store
editor_document_snapshotëŠ” MQë¡œ ì „ë‹¬ë˜ë©°
MQ consumerëŠ” ë‹¤ìŒ ìˆœì„œë¡œ full_document_store(K)ë¥¼ ê°±ì‹ í•œë‹¤:
K.latest_full_text ì½ê¸°
K.previous_full_text = ê¸°ì¡´ latest_full_text
K.latest_full_text = snapshot.full_text
diff_ratio ê³„ì‚°
blocks ì¬êµ¬ì„±
last_synced_at ì—…ë°ì´íŠ¸
ì´ ì €ì¥ êµ¬ì¡°ê°€ Phase 2â†’3â†’4ì˜ í•™ìŠµ ê¸°ë°˜ì´ ëœë‹¤.

1-4. Storage Layer ìƒì„¸ ì„¤ëª…


(A/B/C/I/E/H/G ì €ì¥ì†Œ â€” BigQuery ê¸°ë°˜ DWH)

ëŒ€ê·œëª¨ ë¶„ì„ ë° ETL íŒŒì´í”„ë¼ì¸ì˜ ê¸°ë°˜.

(K â€” MongoDB ê¸°ë°˜ ì›ë³¸ ë¬¸ì„œ ì €ì¥)

ë¬¸ì„œ ì „ì²´ ë‹¨ìœ„ ì €ì¥
diff ê¸°ë°˜ ìºì‹œ ë¬´íš¨í™” ì •ì±…ì— ì‚¬ìš©
Macro Context ìƒì„±ì˜ ìœ ì¼í•œ ì†ŒìŠ¤

(D â€” Postgres/Mongo ê¸°ë°˜ correction_history)

ê¸°ì—… Ground Truth ì €ì¥ì†Œ
correction_history(D)ëŠ” editor_selected_paraphrasing(C) ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ ì§í›„ MQ consumerê°€ ìƒì„±í•œë‹¤.
B(editor_run_paraphrasing)ëŠ” D ìƒì„±ì— ê´€ì—¬í•˜ì§€ ì•ŠëŠ”ë‹¤.

1-5. Offline / Batch Path ìƒì„¸ ì„¤ëª…


(1) K â†’ F Macro Context Generation

Kì˜ full_document_storeë¥¼ ì½ê³ 
diff ratio ê³„ì‚° â†’ diff >= 10% ì‹œ ìºì‹œ ë¬´íš¨í™”
LLM ë¶„ì„ í›„ F.document_context_cache ì—…ë°ì´íŠ¸

(2) A/B/C/D/E/I/H/G â†’ ETL íŒŒì´í”„ë¼ì¸

ETLì€ ë‹¤ìŒì„ ìƒì„±í•œë‹¤:
training_examples(H)
user_profile(G)
cluster_profile(J)
Macro ì¬ê³„ì‚°(F)

1-6. ìºì‹œ ê³„ì¸µ (F/G/J) ì •ì±…

ìºì‹œ
TTL
ì—…ë°ì´íŠ¸ ì¡°ê±´
ë¬´íš¨í™” ì¡°ê±´
F(document_context_cache)
ê¸°ë³¸ TTL = 1ì‹œê°„




ê·¸ëŸ¬ë‚˜ ë‹¤ìŒ ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ TTLì„ ë‹¨ì¶•í•œë‹¤:







ë¬¸ì„œ ìµœê·¼ ì €ì¥ ì‹œì ì´ 5ë¶„ ì´ë‚´ë¼ë©´ â†’ TTL = 5ë¶„
snapshot ìƒì„± ë¹ˆë„ê°€ ë§¤ìš° ë†’ë‹¤ë©´(10ë¶„ ë‚´ 3íšŒ ì´ìƒ) â†’ TTL = 3ë¶„
ë¬¸ì„œê°€ ê±°ì˜ í¸ì§‘ë˜ì§€ ì•ŠëŠ” ê²½ìš°(30ë¶„ ì´ìƒ ë³€í™” ì—†ìŒ) â†’ TTL = 1ì‹œê°„ ìœ ì§€
ì¦‰, ë¬¸ì„œ í¸ì§‘ í™œë™ëŸ‰ì„ ê¸°ë°˜ìœ¼ë¡œ TTLì„ ë™ì ìœ¼ë¡œ ì¡°ì •í•œë‹¤.
| diff_ratio>=10% or TTL |
| G(user_profile) | ë¬´í•œ (0) | ETL ë°°ì¹˜ ì‹¤í–‰ ì‹œ ë®ì–´ì“°ê¸°(Overwrite) | ETL ì‹¤íŒ¨ ì‹œ ì´ì „ ê°’ ì‚¬ìš© |
| J(cluster_profile) | ë¬´í•œ (0) | ETL ë°°ì¹˜ ì‹¤í–‰ ì‹œ ë®ì–´ì“°ê¸°(Overwrite) | clustering ë³€ê²½ |

ğŸ“˜ PART 2 â€” Phaseë³„ ìƒì„¸ ëª…ì„¸ (v2.3 ì™„ì „ ì¬ì‘ì„±ë³¸)

(Phase 1 â†’ Phase 1.5 â†’ Phase 2 â†’ Phase 3 â†’ Phase 4)

ğŸŸ¦ Phase 1: ì‹¤ì‹œê°„ ì¶”ì²œ MVP + Hooks ìˆ˜ì§‘ (v1.0)

ëª©í‘œ:
ì‚¬ìš©ìê°€ ë¬¸ì¥ì„ ë“œë˜ê·¸í–ˆì„ ë•Œ, Vector ê¸°ë°˜ ì ìˆ˜ë¥¼ í†µí•´ ì¦‰ê°ì ì¸ ì¹´í…Œê³ ë¦¬ ì¶”ì²œì„ ì œê³µí•œë‹¤.
ë™ì‹œì— ë¯¸ë˜ì˜ ê³ ë„í™”ë¥¼ ìœ„í•´ ëª¨ë“  í•µì‹¬ â€œHooks(ë°ì´í„° ê³ ë¦¬)â€ë¥¼ ìˆ˜ì§‘í•œë‹¤.

ğŸ”µ 1. Phase 1ì—ì„œ ë‹¬ì„±í•´ì•¼ í•˜ëŠ” ê²ƒ

í•­ëª©
ì„¤ëª…
ì‹¤ì‹œê°„ ì¶”ì²œ ë¡œì§(P_vec)
ìœ ì €ê°€ ë“œë˜ê·¸í•œ ë¬¸ë§¥ì˜ ë²¡í„° ìœ ì‚¬ë„ ê¸°ë°˜ ì¶”ì²œ
Micro-Context ìˆ˜ì§‘(E.context_block)
"ì„ íƒ êµ¬ê°„ ìœˆë„ìš°" ë‹¨ìœ„ì˜ ë¬¸ë§¥/ì„ë² ë”© ì €ì¥
doc_id ê¸°ë°˜ ìˆ˜ì§‘ ì²´ê³„ ë§ˆë ¨
Macro/Personalization ê¸°ë°˜
A/B/C/D íŠ¸ëœì­ì…˜ ì—°ê²° êµ¬ì¡° í™•ë¦½
session ë‹¨ìœ„ consistency í™•ë³´
Ground Truth(D) ê¸°ë°˜ ë¼ë²¨ ìˆ˜ì§‘
field/intensity/selected_index/user_prompt
API/Schema version ê´€ë¦¬ ì‹œì‘
í–¥í›„ í™•ì¥ ëŒ€ë¹„

Phase 1 ìì²´ëŠ” ì¶”ì²œì˜ ì •ë°€ë„ë³´ë‹¤ ë°ì´í„° ìˆ˜ì§‘ êµ¬ì¡°ì˜ ì™„ì„±ë„ì— ë°©ì ì´ ìˆë‹¤.

ğŸŸ¦ 2. Phase 1 ì•„í‚¤í…ì²˜ íë¦„


1) ì‚¬ìš©ì â†’ FE â†’ API ìš”ì²­

ì‚¬ìš©ìê°€ ë¬¸ì¥ì„ ë“œë˜ê·¸í•˜ë©´ FEëŠ” ë‹¤ìŒì„ APIë¡œ ë³´ë‚¸ë‹¤:
doc_id
context_text
context_hash
user_id
api_version, schema_version
recommend_session_idëŠ” í•­ìƒ API ì„œë²„ê°€ ìƒì„±í•œë‹¤.
FEëŠ” API ì‘ë‹µì„ ë°›ì€ ì´í›„ B/C ì´ë²¤íŠ¸ì— í•´ë‹¹ session_idë¥¼ í¬í•¨í•´ ì „ì†¡í•œë‹¤.
â€¢ ì´ session_idëŠ” A/B/C ì´ë²¤íŠ¸ë¥¼ í•˜ë‚˜ë¡œ ë¬¶ëŠ”ë‹¤. (DëŠ” correction_history_idë¡œ ì—°ê²°)

2) ì¶”ì²œ ì—”ì§„ â€” P_vec ê³„ì‚°

context_text â†’ embedding_v1
embedding ê²€ìƒ‰:
KNN(top_k=15)
Synthetic DB ê¸°ë°˜
cosine similarity ë°˜ì˜
ì¶œë ¥:



P_vec = { category:score }




3) P_final = P_vec

Phase 1ì—ì„œëŠ” $P_{rule}$ì€ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©°, Macro(P_doc), ê°œì¸í™”(P_user), í´ëŸ¬ìŠ¤í„°(P_cluster)ëŠ” ë°ì´í„° ìˆ˜ì§‘ ë‹¨ê³„ì´ë¯€ë¡œ ì¶”ì²œ ì ìˆ˜ì—ëŠ” ë°˜ì˜í•˜ì§€ ì•ŠëŠ”ë‹¤.

4) ì¶”ì²œ ê²°ê³¼ ë°˜í™˜ ë° A ì´ë²¤íŠ¸ ìƒì„±

A ì´ë²¤íŠ¸ = editor_recommend_options
ì €ì¥ë˜ëŠ” ì£¼ìš” í•„ë“œ:
insert_id (PK)
recommend_session_id
doc_id
context_hash
reco_category_input
P_vec
model_version
api_version / schema_version

5) ë¬¸ì„œ Hooks ìˆ˜ì§‘: context_block(E)

ë¹„ë™ê¸° íì—ì„œ ë‹¤ìŒ ì‘ì—… ì‹¤í–‰:
ë¬¸ë§¥ í…ìŠ¤íŠ¸ preview ì €ì¥
embedding_v1 ì €ì¥
embedding_version = "v1.0"

6) ì‹¤í–‰(B) / ì„ íƒ(C) / ê¸°ë¡(D) ì—°ê²°

A â†’ B â†’ C â†’ DëŠ” ë‹¤ìŒ ê´€ê³„ë¡œ ì—°ê²°ëœë‹¤:
A/B/C ì´ë²¤íŠ¸ëŠ” ë™ì¼í•œ recommend_session_id ê³µìœ 
BëŠ” source_recommend_event_idë§Œ ì €ì¥í•˜ë©° correction_history_idë¥¼ ê°–ì§€ ì•ŠëŠ”ë‹¤.
D(correction_history)ëŠ” C(editor_selected_paraphrasing)ê°€ ë°œìƒí•˜ëŠ” ìˆœê°„ ìƒì„±ë˜ë©°,
ìƒì„±ëœ D._idê°€ C.correction_history_idì— ì €ì¥ëœë‹¤.
DëŠ” ìµœì¢… Ground Truth

ğŸŸ¦ 3. Phase 1ì—ì„œì˜ ë°ì´í„° ë° ìŠ¤í‚¤ë§ˆ


ìƒì„±:

E.context_block
A.editor_recommend_options
I.recommend_log

í™œìš©:

Synthetic embedding DB
D.correction_history (ê¸°ì¡´)

ğŸŸ¦ 4. Phase 1 ì™„ë£Œ ê¸°ì¤€

P_vec ê¸°ë°˜ ì¶”ì²œì´ 300ms ì´ë‚´ ì‘ë™
E.context_block ìƒì„±ë¥  99% ì´ìƒ
recommend_session_id ê¸°ë°˜ì˜ Aâ€“Bâ€“Câ€“D ì²´ì¸ ì„±ê³µë¥  99%
schema_version backward-compatibility ê²€ì¦ ì™„ë£Œ

ğŸŸ¦ğŸŸ© Phase 1.5: Macro Context Hybrid (v1.5)

ëª©í‘œ:
ë¬¸ì„œì˜ ë¶€ë¶„(Micro) ëŒ€ì‹  **ì „ì²´ ë¬¸ì„œ(Macro)**ì— ê¸°ë°˜í•œ ì¶”ì²œ ì„±ëŠ¥ í–¥ìƒ.
íŠ¹ì • ë¬¸ì¥ë§Œ ë³´ê³  ì˜¤ë¥˜ë‚œ ì¹´í…Œê³ ë¦¬ë¥¼ ë¬¸ì„œ ë‹¨ìœ„ë¡œ ë³´ì •í•˜ëŠ” íš¨ê³¼.

1. Phase 1.5 í•µì‹¬ ê°œë… ì •ë¦¬


â— ë¬¸ì„œ ì „ì²´(Macro)ì™€ ë¬¸ì¥(Micro)ì€ ì™„ì „íˆ ë‹¤ë¥¸ íŒŒì´í”„ë¼ì¸ì´ë‹¤.

í•­ëª©
Micro (E)
Macro (Kâ†’F)
ì €ì¥ ì‹œì 
A ì´ë²¤íŠ¸ ì§í›„
FE ë¬¸ì„œ ì €ì¥ ì‹œ
ì €ì¥ ë‹¨ìœ„
ì„ íƒ ìœˆë„ìš°
ë¬¸ì„œ ì „ì²´
ì €ì¥ ìœ„ì¹˜
E.context_block
K.full_document_store
ë¶„ì„ ë°©ì‹
embedding ê²€ìƒ‰(KNN)
LLM ê¸°ë°˜ ë¬¸ì„œ ìš”ì•½/í† í”½ ë¶„ë¥˜
ì‹¤ì‹œê°„ ì¡°íšŒ
Vector Search
K-V Cache ì¡°íšŒ
ì¶”ì²œ ë°˜ì˜
P_vec
P_doc


2. Phase 1.5 ìƒì„¸ ê¸°ëŠ¥ ì„¤ëª…


(1) K.full_document_store ì €ì¥ â€” ë¬¸ì„œ ì›ë³¸ ì €ì¥ Hook

FEëŠ” ë¬¸ì„œ ì €ì¥ ë˜ëŠ” ìë™ ì €ì¥ ì‹œì ë§ˆë‹¤ ë‹¤ìŒ ì´ë²¤íŠ¸ ë°œí–‰:
editor_document_snapshot
diff ê¸°ë°˜ ì—…ë°ì´íŠ¸
snapshot.prev_full_textëŠ” ì„œë²„ê°€ K.latest_full_textë¥¼ ì½ì–´ ì±„ìš´ ê°’ì´ë©°
FEì—ì„œ ì „ë‹¬í•˜ì§€ ì•ŠëŠ”ë‹¤.
MongoDB(K)ì— ì €ì¥
K í…Œì´ë¸” êµ¬ì¡°ëŠ” ì•„ë˜ì™€ ê°™ìŒ:



doc_id
blocks[]
last_synced_at



v2.2 ì—…ë°ì´íŠ¸: diff_ratio ê³„ì‚°ì„ ìœ„í•´ ì´ì „ ë²„ì „ì˜ ë¬¸ì„œ ì¡°ê°ì„ í•¨ê»˜ ì €ì¥í•˜ëŠ” êµ¬ì¡°ë¡œ í™•ì¥ ê°€ëŠ¥.

(2) ETL: K â†’ LLM â†’ F.document_context_cache

ì „ë¬¸ LLMì— full_textë¥¼ ì „ë‹¬í•˜ì—¬ ë‹¤ìŒ ì •ë³´ ìƒì„±:
macro_topic
macro_category_hint
ë¬¸ì„œ í’ˆì§ˆ í˜•ì‹(Optional)
updated_at
valid_until(TTL)
invalidated_by_diff (v2.2)
diff_ratio (v2.2)
LLM outputì€ K-V êµ¬ì¡°ë¡œ ë³€í™˜ë˜ì–´ Redis(F)ì— ì €ì¥ëœë‹¤.

(3) ì¶”ì²œ ë¡œì§ ì—…ê·¸ë ˆì´ë“œ (P_doc í†µí•© ë° ë™ì  ê°€ì¤‘ì¹˜)

Phase 1.5ì—ì„œ ì¶”ì²œ í•¨ìˆ˜ëŠ” **ë¬¸ì„œ ì„±ìˆ™ë„(Maturity)**ì— ë”°ë¼ ê°€ì¤‘ì¹˜ë¥¼ ë™ì ìœ¼ë¡œ ì¡°ì ˆí•œë‹¤.



# ì˜ì‚¬ì½”ë“œ (Pseudo-code)
maturity_score = calculate_maturity(doc_length) # 0.0 ~ 1.0 (Log Scale)
alpha = BASE_ALPHA * maturity_score             # BASE_ALPHA = 0.4 (ì˜ˆì‹œ)

P_final = (1 - alpha) * P_vec + alpha * P_doc



Cold Start (0~50ì): $\alpha = 0$. Micro Context(P_vec)ì— 100% ì˜ì¡´.
Growing (50~500ì): ë¬¸ì„œ ì–‘ì´ ëŠ˜ì–´ë‚ ìˆ˜ë¡ $\alpha$ ì ì§„ì  ì¦ê°€.
Mature (500ì+): ìµœëŒ€ $\alpha$ ì ìš©. P_docì´ ê°•ë ¥í•œ ê°€ì´ë“œë¼ì¸(Guideline)ìœ¼ë¡œ ì‘ìš©.

(4) ìºì‹œ ë¬´íš¨í™” ê·œì¹™ (v2.2 ì™„ì „íŒ)

ì¡°ê±´
ì„¤ëª…
diff_ratio >= 0.10
ì¦‰ì‹œ ë¬´íš¨í™” ë° ìºì‹œ ì¬ìƒì„± ì˜ˆì•½
TTL ë§Œë£Œ
ê¸°ë³¸ ë§Œë£Œ ì •ì±… (ì˜ˆ: 1ì‹œê°„)
doc_id ì†Œìœ ìê°€ ì–¸ì–´ ì„¤ì • ë³€ê²½
ì–¸ì–´ ê¸°ë°˜ ì¹´í…Œê³ ë¦¬ ëª¨ë¸ì—ì„œ í•„ìš”


(5) A ì´ë²¤íŠ¸ í™•ì¥

A.editor_recommend_optionsì— ë‹¤ìŒ í•„ë“œë¥¼ ì¶”ê°€:
P_doc
applied_weight_doc (ì‹¤ì œ ì ìš©ëœ alpha ê°’)
doc_maturity_score
cache_hit (F ì¡°íšŒ ì—¬ë¶€)
api_version / schema_version
recommend_session_id
"embedding_version": "string"
"llm_version": "string" (ì„ íƒ)

3. Phase 1.5 ì™„ë£Œ ê¸°ì¤€

F.cache ìƒì„±ë¥  97% ì´ìƒ
P_doc ì ìˆ˜ ë°˜ì˜ ë¡œì§ ë° ë™ì  ê°€ì¤‘ì¹˜ ì •í™•ì„± ê²€ì¦
Macro ìºì‹œ ë¬´íš¨í™” ì •ì±… ì •ìƒ ì‘ë™ (diff-triggered reset)

ğŸŸ¦ğŸŸ¨ Phase 2: ë°ì´í„° ì¶•ì  / í•™ìŠµ íŒŒì´í”„ë¼ì¸ (v2.0)

ëª©í‘œ:
Phase 1.5ê¹Œì§€ ìˆ˜ì§‘ëœ A/B/C/D/E/K/I ë¡œê·¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ
**í•™ìŠµìš© ë°ì´í„°(training_examples)**ì™€
**ì‚¬ìš©ì í”„ë¡œí•„(user_profile)**ì„ ìƒì„±í•˜ê³ 
ì‹œìŠ¤í…œì„ ë°ì´í„° ê¸°ë°˜ ì¶”ì²œ ì²´ê³„ë¡œ ì „í™˜í•œë‹¤.
(2.4)
ìˆ˜ì§‘ëœ ë¡œê·¸(A~I)ë¥¼ MongoDBì— ì•ˆì •ì ìœ¼ë¡œ ì ì¬í•˜ê³ , ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ **í•™ìŠµ ë°ì´í„°(H)**ì™€ **ìœ ì € í”„ë¡œí•„(G)**ì„ ìƒì„±í•˜ë©°, ëŒ€ì‹œë³´ë“œë¥¼ í†µí•´ ë°ì´í„° ê°€ì¹˜ë¥¼ ì¦ëª…í•œë‹¤.

ğŸ”µ 1. Phase 2ì˜ í•µì‹¬ ë³€í™”

ê¸°ëŠ¥
ì„¤ëª…
training_examples ìƒì„± (H)
A/B/C/D/E/F ì¡°ì¸ì„ í†µí•´ supervision ìƒì„±
user_profile ìƒì„± (G)
ì‚¬ìš©ìë³„ ì„ í˜¸/í–‰ë™/ì–¸ì–´ íŒ¨í„´ ì§‘ê³„
Vector DB Hybrid ì „í™˜
synthetic â†’ real embedding ì¤‘ì‹¬ êµ¬ì¡°
Session consistency ê²€ì¦
ëª¨ë“  A/B/C/D ì´ë²¤íŠ¸ì˜ recommend_session_id ê²€ì¦
Analytics Dashboard
Streamlit Sidecar íŒ¨í„´ìœ¼ë¡œ ì‹¤ì‹œê°„ ì§€í‘œ ì‹œê°í™”


ğŸŸ¦ 2. Phase 2 í•™ìŠµ ë°ì´í„° ìƒì„±(H)

HëŠ” ë‹¤ìŒ ì†ŒìŠ¤ë¡œ ìƒì„±ëœë‹¤:
ì†ŒìŠ¤
ëª©ì 
A(editor_recommend_options)
Input: ì¶”ì²œê°’, ëª¨ë¸ ì ìˆ˜
B(editor_run_paraphrasing)
Label: target_language
C(editor_selected_paraphrasing)
Label: was_accepted
D(correction_history)
Label: field, intensity, selected_index, user_prompt
E(context_block)
Input: context_embedding
F(document_context_cache)
Input: macro_category_hint


ğŸ”§ Session Consistency Rule (v2.2)




if (abs(A.timestamp - B.timestamp) > 5s) â†’ low_consistency
if (C.was_accepted == false and D.selected_index != null) â†’ inconsistency error
if (B.source_id != A.insert_id) â†’ drop



ëª¨ë“  training_examplesëŠ” consistency_flagë¥¼ ê°€ì§„ë‹¤:
high
low (í•™ìŠµ ì œì™¸)

ğŸŸ¦ 3. Phase 2 User Profile ìƒì„±(G)

ê° ì‚¬ìš©ì ê¸°ì¤€ ì§‘ê³„:
í•„ë“œ
ì„¤ëª…
preferred_category_vector
ì „ì²´ ì¹´í…Œê³ ë¦¬ë¶„í¬ ë²¡í„° (ê³ ì • ê¸¸ì´)
preferred_strength_vector
ê°•ë„ ë¶„í¬
preferred_language_vector
ì–¸ì–´ ë¶„í¬
recommend_accept_rate
ì¶”ì²œ â†’ ì„ íƒ í™•ë¥ 
top_style_requests
ì£¼ìš” ì„œìˆ  ì˜µì…˜
user_embedding_v1
user behavior embedding

v2.2 ìˆ˜ì •:
JSON object í˜•ì‹ ëŒ€ì‹  ê³ ì • ê¸¸ì´ ë²¡í„° ì‚¬ìš©í•˜ì—¬ ML/ì‹¤ì‹œê°„ ì¡°íšŒ ìµœì í™”.

ğŸŸ¦ 4. Vector DB Hybrid ì „í™˜


ì¡°ê±´ ê¸°ë°˜ ì „í™˜:




if user_training_data_count < N:
    weight_synthetic = 1
else:
    weight_synthetic = 0



ë˜ëŠ” progressive hybrid:



weight_synthetic = max(0, 1 - log(k))



Phase 2ì—ì„œëŠ” K.full_document_storeì˜ blocks[]ë¥¼ chunk ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ì—¬
ê° chunkì— embedding_v1ì„ ìƒì„±í•œ ë’¤ VectorDBì— ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.
ì´ë•Œ embedding_versionì€ ë¬¸ì¥(E)ê³¼ ë™ì¼í•œ ëª¨ë¸ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

ğŸŸ¦ 5. Analytics Dashboard V1 (ë°ì´í„° ê°€ì¹˜ ì‹œê°í™”)
ëª©í‘œ:
ìˆ˜ì§‘ëœ ë°ì´í„°(H, G)ì™€ ì‹œìŠ¤í…œ ë¡œê·¸(I)ë¥¼ ë¶„ì„í•˜ì—¬ **"ë°ì´í„° ìì‚°ì˜ ê°€ì¹˜"**ì™€ **"ì‚¬ìš©ì í–‰ë™ íŒ¨í„´"**ì„ ì‹œê°ì ìœ¼ë¡œ ì¦ëª…í•œë‹¤.
(1) ëŒ€ì‹œë³´ë“œ ì£¼ìš” ì„¹ì…˜ ë° ì§€í‘œ (KPI)
ì„¹ì…˜
ë¶„ì„ í•­ëª©
ì‹œê°í™” ì°¨íŠ¸ ì˜ˆì‹œ
ë°ì´í„° ìì‚° (Asset)
â€¢ í•™ìŠµ ë°ì´í„°(H) ëˆ„ì  ê°œìˆ˜ (Golden Data ë¹„ìœ¨)

â€¢ ìœ ì € í”„ë¡œí•„(G) ìƒì„± ì»¤ë²„ë¦¬ì§€
Line Chart: ì¼ë³„ ë°ì´í„° ëˆ„ì ëŸ‰ ì¶”ì´

Pie Chart: ê³ í’ˆì§ˆ(High-Consistency) ë°ì´í„° ë¹„ìœ¨
ì‚¬ìš©ì í–‰ë™ (Behavior)
â€¢ Drafting vs Polishing: ëŒ€ëŸ‰ ìˆ˜ì •(Diff>10%)ê³¼ ë¯¸ì„¸ ìˆ˜ì • ë¹„ìœ¨

â€¢ Hot Topics: Macro ETLì´ ì¶”ì¶œí•œ ìƒìœ„ í† í”½ í‚¤ì›Œë“œ
Bar Chart: ìˆ˜ì • ìœ í˜•ë³„ ë¹ˆë„

Word Cloud: ì£¼ìš” ì‘ì„± í† í”½ (ë³´ê³ ì„œ, ì´ë©”ì¼ ë“±)
ì¶”ì²œ ì„±ê³¼ (Performance)
â€¢ Top-1 Accept Rate: 1ìˆœìœ„ ì¶”ì²œ ìˆ˜ìš©ë¥ 

â€¢ Funnel: View(A) â†’ Run(B) â†’ Accept(C) ì „í™˜ìœ¨
Funnel Chart: ë‹¨ê³„ë³„ ì´íƒˆë¥  ë¶„ì„

Time Series: ì£¼ê°„ ìˆ˜ìš©ë¥  ë³€í™” ê·¸ë˜í”„
ì‹œìŠ¤í…œ ìƒíƒœ (System)
â€¢ Macro Cache(F) ì ì¤‘ë¥  (Hit Rate)

â€¢ ETL ì²˜ë¦¬ ì§€ì—° ì‹œê°„ (Latency)
Gauge Chart: ì‹¤ì‹œê°„ ìºì‹œ ì ì¤‘ë¥ 

Heatmap: ì‹œê°„ëŒ€ë³„ ETL ë¶€í•˜ ë¶„í¬

(2) ê¸°ìˆ  ìŠ¤íƒ
Backend: Python (Streamlit) - Sidecar Container
Source: MongoDB (Direct Query), Redis (Cache Status)

ğŸŸ¦ 6. Phase 2 ì™„ë£Œ ê¸°ì¤€

training_examples(H) ìƒì„± ì„±ê³µë¥  99% ì´ìƒ
user_profile(G) ìƒì„± ì„±ê³µë¥  97% ì´ìƒ
synthetic ì œê±° í…ŒìŠ¤íŠ¸ ì™„ë£Œ
dashboard: reco_accept_ratio, macro_hit_rate ì •ìƒ ë…¸ì¶œ

ğŸŸ¦ğŸŸ§ Phase 3: ê°œì¸í™” ì¶”ì²œ (v3.0)

ëª©í‘œ:
Phase 2ì—ì„œ ì–»ì€ user_profileì„ ê¸°ë°˜ìœ¼ë¡œ
ê°œì¸ë³„ë¡œ ë‹¤ë¥¸ ì¶”ì²œì„ ìƒì„±í•œë‹¤.

ğŸ”µ 1. Phase 3 í•µì‹¬ ë³€í™”

ê¸°ëŠ¥
ì„¤ëª…
user_embeddings ìƒì„±
user_profile ê¸°ë°˜
P_user ê³„ì¸µ ì¶”ê°€
ê°œì¸í™” ì ìˆ˜
cluster_profile(J) ì¶”ê°€
ìœ ì‚¬ ì‚¬ìš©ì ê¸°ë°˜ ì ìˆ˜
P_cluster ì¶”ê°€
í´ëŸ¬ìŠ¤í„° ì ìˆ˜
Strength predictor / Language predictor ê°œë°œ
êµì • ê°•ë„/ì–¸ì–´ ìë™ ì¶”ì²œ


ğŸŸ¦ 2. ì‚¬ìš©ì ì„ë² ë”©(user_embeddings)

ìƒì„± ë°©ë²• ì˜ˆì‹œ:
RNN ê¸°ë°˜ sequence embedding
í‰ê·  í’€ë§ ê¸°ë°˜ ê°„ë‹¨ ì„ë² ë”©
BERT embedding ê¸°ë°˜ behavioral embedding
user_profile â†’ linear projection
output: 384-dim ë˜ëŠ” 768-dim ë²¡í„°

ğŸŸ¦ 3. í´ëŸ¬ìŠ¤í„° í”„ë¡œí•„(cluster_profile)

Phase 3ì—ì„œ ì²˜ìŒ ë“±ì¥í•˜ëŠ” ì‹ ê·œ ìŠ¤í‚¤ë§ˆ(J)
êµ¬ì„±:
cluster_id
cluster_idëŠ” Phase 3ë¶€í„° ETLì´ user_profileì— ì €ì¥í•˜ëŠ” ê°œë…ì´ë©°
cluster_profile ì¡°íšŒëŠ” user_profile â†’ cluster_id â†’ profile ìˆœìœ¼ë¡œ ì´ë¤„ì§„ë‹¤.
centroid_embedding
category_vector
strength_vector
language_vector
last_updated

ğŸŸ¦ 4. ì¶”ì²œ ë¡œì§ í™•ì¥ (v3.0)




P_final = f(
  P_vec,
  P_doc,
  P_user,
  P_cluster
)



P_user ê³„ì‚° ì˜ˆ:



P_user = cosine(user_embedding, category_centroid)



P_cluster ê³„ì‚° ì˜ˆ:



P_cluster = cluster_category_vector[reco_category]




ğŸŸ¦ 5. Strength/Language Predictor

Phase 3ì—ì„œ ë‹¤ìŒ 2ê°œ ëª¨ë¸ì´ ì¶”ê°€ë¨:
strength_predictor
ì…ë ¥: context_embedding + user_embedding
ì¶œë ¥: "weak/moderate/strong"
language_predictor
ì…ë ¥: context_embedding + user_profile_language_vector
ì¶œë ¥: ì–¸ì–´(ko/en/jp ë“±)

ğŸŸ¦ 6. Phase 3 ì™„ë£Œ ê¸°ì¤€

P_user í™œì„±í™”
cluster_profile ì¡°íšŒ 95% ì„±ê³µ
strength predictor ì •í™•ë„ ê¸°ì¤€ì¹˜ ë‹¬ì„±
ì–¸ì–´ predictor ì •í™•ë„ ê¸°ì¤€ì¹˜ ë‹¬ì„±

ğŸŸ¥ Phase 4: ì„œìˆ í˜• ì˜µì…˜ ìë™í™” (v4.0)

ëª©í‘œ:
Phase 3ê¹Œì§€ëŠ” â€œì˜µì…˜ ì¶”ì²œâ€ì´ ëª©í‘œë¼ë©´,
Phase 4ë¶€í„°ëŠ” ì„œìˆ í˜• ì˜µì…˜ì„ LLMì´ ìë™ ìƒì„±í•˜ëŠ” ë‹¨ê³„ì´ë‹¤.
ì¦‰,
ì‚¬ìš©ìê°€ ì§ì ‘ â€œì¢€ ë” ê°„ê²°í•˜ê²Œâ€ ê°™ì€ ì„œìˆ í˜• ë¬¸ì¥ì„ ì“°ì§€ ì•Šì•„ë„
AIê°€ ë¬¸ë§¥ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„±í•´ ì œì•ˆí•œë‹¤.

ğŸŸ¦ 1. Phase 4 í•µì‹¬ ìš”ì†Œ

ìš”ì†Œ
ì„¤ëª…
Tone/Style Generator LLM
user_prompt ìë™ ìƒì„±
Prompt Composer
Micro + Macro + User Profile + Cluster ëª¨ë‘ ê²°í•©
Full-Context LLM
ë¬¸ì„œ ì „ì²´ ê¸°ë°˜ êµì • ìˆ˜ì¤€ ê°•í™”
Feedback loop ê°•í™”
user_prompt_label í•™ìŠµ


ğŸŸ¦ 2. Tone/Style Generator

ì…ë ¥ êµ¬ì„±:
context_embedding (E)
macro_category_hint (F)
user_embedding (G)
cluster_pattern (J)
ê¸°ì¡´ user_prompt í†µê³„(D.user_prompt)
ì¶œë ¥:
ìì—°ì–´ ê¸°ë°˜ ì˜µì…˜ í…ìŠ¤íŠ¸
ì˜ˆ: â€œì¢€ ë” ê°„ê²°í•˜ê²Œâ€, â€œë” ì¼ìƒì ì¸ í‘œí˜„ìœ¼ë¡œ ë°”ê¿”ì£¼ì„¸ìš”â€

ğŸŸ¦ 3. Prompt Composer (Phase 4 í•µì‹¬ ì—”ì§„)

ìµœì¢… LLM inputì„ ìë™ ìƒì„±í•˜ëŠ” êµ¬ì„± ìš”ì†Œ.
ì…ë ¥:
Micro context (ì„ íƒ ë¬¸ì¥)
Macro context (ë¬¸ì„œ ìš”ì•½)
user_profile (ì„ í˜¸ë„)
user_embeddings
style generator output
reco_category / reco_strength / reco_language
ì¶œë ¥:
LLMì—ê²Œ ì „ë‹¬í•˜ëŠ” ì™„ì„±ëœ instruction prompt

ğŸŸ¦ 4. Phase 4 ì™„ë£Œ ê¸°ì¤€

ìŠ¤íƒ€ì¼ ì˜µì…˜ì„ ì‚¬ìš©ìê°€ ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ìë™ ìƒì„±ë¨
ì‚¬ìš©ìê°€ ì„ íƒ ê°€ëŠ¥
Feedback í•™ìŠµ ë£¨í”„ ì •ìƒ ì‘ë™
ì¶”ì²œ â†’ ì‹¤í–‰ â†’ ì„ íƒê¹Œì§€ End-to-End ìë™í™”

ğŸ“˜ PART 3 â€” ì „ì²´ ìŠ¤í‚¤ë§ˆ(v2.3 ì™„ì „ ì¬ì‘ì„±ë³¸)


(A~I + í™•ì¥ ìŠ¤í‚¤ë§ˆ E/F/G/H/J + K í¬í•¨)


(í•„ë“œ ë‹¨ í•˜ë‚˜ë„ ëˆ„ë½ ì—†ì´ + v2.3 ìˆ˜ì •ì‚¬í•­ ë°˜ì˜ ë²„ì „)


ğŸŸ¦ A. editor_recommend_options (Phase 1~3 í•µì‹¬ ì‹¤ì‹œê°„ ë¡œê·¸)

ì„¤ëª…: ì¶”ì²œì´ ìƒì„±ë  ë•Œë§ˆë‹¤ ê¸°ë¡ë˜ëŠ” ì‹¤ì‹œê°„ ì˜µì…˜ ì´ë²¤íŠ¸.
Phase ì—…ê·¸ë ˆì´ë“œì— ë”°ë¼ í•„ë“œ ì¦ê°€.

JSON


{
  "insert_id": "string",                    // PK, UUID
  "recommend_session_id": "string",         // A/B/C/D ì—°ê²°ìš© ì„¸ì…˜ ID
  "user_id": "string",
  "doc_id": "string",
  "context_hash": "string",

  "reco_category_input": "string",          // ì¹´í…Œê³ ë¦¬ ì¶”ì²œ ê²°ê³¼(top-1)
	"reco_options": ["object"], // í›„ë³´ ì˜µì…˜ ë¦¬ìŠ¤íŠ¸ (Phase 3+ë¶€í„° êµ¬ì¡°ì²´) /* Phase 3 ì˜ˆì‹œ: { "category": "email", "strength": "moderate" } */

  "P_vec":  { "category": "number" },       // vector ê¸°ë°˜ ì ìˆ˜ í…Œì´ë¸”
  "P_doc":  { "category": "number" },       // macro ê¸°ë°˜ ì ìˆ˜ (1.5+)
  "P_user": { "category": "number" },       // user ê¸°ë°˜ ì ìˆ˜ (3+)
  "P_cluster": { "category": "number" },    // cluster ê¸°ë°˜ ì ìˆ˜ (3+)

  "weight_vec": "number",
  "weight_doc": "number",
  "weight_user": "number",
  "weight_cluster": "number",
  
  "doc_maturity_score": "number",           // (ì‹ ê·œ) 0.0~1.0 ë¬¸ì„œ ì„±ìˆ™ë„
  "applied_weight_doc": "number",           // (ì‹ ê·œ) ì‹¤ì œ ì ìš©ëœ alpha ê°’

  "model_version": "string",
  "api_version": "string",
  "schema_version": "string",

  "cache_hit_macro": "boolean",             // F(document_context_cache) hit ì—¬ë¶€
  "cache_hit_user": "boolean",              // G(user_profile)
  "cache_hit_cluster": "boolean",           // J(cluster_profile)

  "created_at": "datetime",
  "embedding_version": "string",
  "llm_version": "string" (ì„ íƒ)
}




ğŸŸ¦ B. editor_run_paraphrasing (Phase 1 ì‹¤í–‰ ì´ë²¤íŠ¸)

ì„¤ëª…: ì¶”ì²œ ì˜µì…˜ì„ ì‹¤í–‰í–ˆì„ ë•Œ ë°œìƒí•˜ëŠ” ë¡œê·¸.

JSON


{
  "source_recommend_event_id": "string",   // A.insert_id
  "recommend_session_id": "string",

  "doc_id": "string",
  "user_id": "string",

  "target_language": "string",             // ko/en/jp ë“±
  "target_intensity": "string",            // weak / moderate / strong
  "target_category": "string",

  "executed_at": "datetime",
  "created_at": "datetime",
  "paraphrase_llm_version": "string"
}




ğŸŸ¦ C. editor_selected_paraphrasing (Phase 1 ì„ íƒ ì´ë²¤íŠ¸)

ì„¤ëª…: ìˆ˜ì • í›„ë³´ ì¤‘ ì‹¤ì œ ì„ íƒ ì—¬ë¶€.

JSON


{
  "source_recommend_event_id": "string",   // A.insert_id
  "recommend_session_id": "string",

  "user_id": "string",
  "doc_id": "string",

  "selected_option_index": "int",          // ì„ íƒ ì•ˆí•˜ë©´ null
  "was_accepted": "boolean",

  "created_at": "datetime",
  "correction_history_id": "string",
  "paraphrase_llm_version": "string"

}




ğŸŸ¦ D. correction_history (ê¸°ì¡´ Ground Truth ìŠ¤í‚¤ë§ˆ)

ì„¤ëª…: ê¸°ì—… ë ˆê±°ì‹œ Ground Truth.

JSON


{
  "_id": "string",                         // ObjectID ë¬¸ìì—´
  "user": "string|null",                   // ObjectID string
  "field": "string",                       // ì¹´í…Œê³ ë¦¬ ë¼ë²¨
  "intensity": "string",                   // weak/moderate/strong
  "user_prompt": "string",                 // ìì—°ì–´ ì˜µì…˜ëª…
  "input_sentence": "string",
  "output_sentences": ["string"],
  "selected_index": "int|null",
  "created_at": "datetime",

}




ğŸŸ¦ E. context_block (Micro Context ìŠ¤í‚¤ë§ˆ / Phase 1 í•µì‹¬)

ì„¤ëª…: ì„ íƒ êµ¬ê°„ ìœˆë„ìš° ë¬¸ë§¥ ë° ì„ë² ë”© ì €ì¥.

JSON


ì„¤ëª…: "ì„ íƒ êµ¬ê°„ ìœˆë„ìš° (Micro-Window)"ì˜ ë¬¸ë§¥ê³¼ ì„ë² ë”© ì €ì¥.
{
  "context_hash": "string",        // PK: hash(doc_id + context_full)
  "doc_id": "string",
  "user_id": "string",             // (ì‹ ê·œ ì¶”ê°€)

  "selected_text": "string",       // ë“œë˜ê·¸í•œ ì‹¤ì œ í…ìŠ¤íŠ¸
  "context_prev": "string",        // ì• ë¬¸ì¥
  "context_next": "string",        // ë’¤ ë¬¸ì¥

  "context_preview": "string",     // UIìš© ë¯¸ë¦¬ë³´ê¸° (selected_text)
  "context_full": "string",        // ì„ë² ë”© ë° ê²€ìƒ‰ìš© (prev + SEP + selected + SEP + next)

  "embedding_v1": ["number"],      // context_full ê¸°ë°˜ ì„ë² ë”©
  "embedding_version": "string",   

  "source": "string",              
  "created_at": "datetime"
}



ğŸŸ¦ M**. document_chunk**

ì„¤ëª…: K.full_document_storeì˜ ë¸”ë¡ ë‹¨ìœ„ ì„ë² ë”© ì €ì¥.

JSON


/* ğŸŸ¦ M_document_chunk (ì‹ ê·œ ìŠ¤í‚¤ë§ˆ / Phase 2+) */
/* ì„¤ëª…: K.full_document_storeì˜ ë¸”ë¡ ë‹¨ìœ„ ì„ë² ë”© ì €ì¥. */
{
  "block_hash": "string",        // PK (doc_id + block_indexì˜ í•´ì‹œ)
  "doc_id": "string",
  "block_index": "int",
  "embedding_v1": ["number"],
  "embedding_version": "string",
  "created_at": "datetime"
}



ğŸŸ¦ F. document_context_cache (Macro Context ìºì‹œ / Phase 1.5 í•µì‹¬)

ì„¤ëª…: K.full_document_store ê¸°ë°˜ LLM ë¶„ì„ ê²°ê³¼ ì €ì¥ (K-V Cache).

JSON


{
  "doc_id": "string",                      // PK

  "macro_topic": "string",                 // ë¬¸ì„œ ìš”ì•½ í† í”½
  "macro_category_hint": "string",         // ë¬¸ì„œ ê¸°ë°˜ ì¶”ì²œ íŒíŠ¸

  "cache_hit_count": "int",
  "last_updated": "datetime",
  "valid_until": "datetime",               // TTL

  "invalidated_by_diff": "boolean",        // diff_ratio â‰¥ 10% íŠ¸ë¦¬ê±°
  "diff_ratio": "number",                  // 0.0~1.0

  "macro_llm_version": "string",
  "schema_version": "string"
}




ğŸŸ¦ G. user_profile (Phase 2 í•µì‹¬ ì‚°ì¶œë¬¼)

ì„¤ëª…: ì‚¬ìš©ìë³„ ì„ í˜¸, ë¶„í¬, ì„ë² ë”© ë“± ì§‘ê³„.
v2.2: JSON ê°ì²´ ëŒ€ì‹  ML ìµœì í™”ë¥¼ ìœ„í•´ ì „ë¶€ ê³ ì • ê¸¸ì´ ë²¡í„°ë¡œ í†µì¼.

JSON


{
  "user_id": "string",                     // PK

  "preferred_category_vector": ["number"], // length = #category
  "preferred_strength_vector": ["number"], // weak/moderate/strong
  "preferred_language_vector": ["number"], // ko/en/jp ë“±

  "recommend_accept_rate": "number",       // ì„ íƒë¥  í†µê³„
  "paraphrase_execution_count": "int",
  "embedding_interaction_count": "int",

  "user_embedding_v1": ["number"],         // 384d or 768d
  "updated_at": "datetime",

  "schema_version": "string",
  "cluster_id": "string"

}

phase2: cluster_id = null
phase3 ë¶€í„° ì‚¬ìš©




ğŸŸ¦ H. training_examples (Phase 2 í•™ìŠµ ë°ì´í„°)

ì„¤ëª…: A/B/C/D/E/F ì „ì²´ë¥¼ ì¡°ì¸í•œ supervised ì˜ˆì œ.

JSON


{
  "example_id": "string",                  // PK
  "recommend_session_id": "string",        // consistency check ê¸°ì¤€

  "user_id": "string",
  "doc_id": "string",

  "context_embedding": ["number"],         // E
  "macro_category_hint": "string|null",    // F

  "reco_category_input": "string",         // A
  "reco_scores_vec": { "category": "number" },
  "reco_scores_doc": { "category": "number|null" },

  "executed_target_language": "string|null",   // B
  "executed_target_intensity": "string|null",  // B
  "executed_target_category": "string|null",   // B

  "was_accepted": "boolean|null",              // C
  "selected_option_index": "int|null",         // C

  "groundtruth_field": "string|null",          // D
  "groundtruth_intensity": "string|null",
  "groundtruth_user_prompt": "string|null",
  "groundtruth_selected_index": "int|null",

  "consistency_flag": "string",                // high / low (v2.2 í•µì‹¬)
  "created_at": "datetime",

  "schema_version": "string"
}




ğŸŸ¦ I. recommend_log (ì¶”ì²œ ë©”íŠ¸ë¦­ ë¶„ì„ìš©)

ì„¤ëª…: ì¶”ì²œì˜ scoreÂ·ê°€ì¤‘ì¹˜Â·ëª¨ë¸ë²„ì „ ë“± ìƒì„¸ ë¡œê¹….

JSON


{
  "log_id": "string",

  "user_id": "string",
  "doc_id": "string",
  "recommend_session_id": "string",

  "P_vec": { "category": "number" },
  "P_doc": { "category": "number" },
  "P_user": { "category": "number" },
  "P_cluster": { "category": "number" },

  "weight_vec": "number",
  "weight_doc": "number",
  "weight_user": "number",
  "weight_cluster": "number",

  "latency_ms": "number",
  "cache_hit_macro": "boolean",
  "cache_hit_user": "boolean",
  "cache_hit_cluster": "boolean",

  "model_version": "string",
  "api_version": "string",
  "schema_version": "string",

  "created_at": "datetime"
}

Phase 1ì—ì„œëŠ” P_doc, P_user, P_cluster í•„ë“œì— {} (empty dict)ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤. (nullì´ ì•„ë‹˜)
Phase 1.5ë¶€í„° í•„ë“œ ìƒì„±




ğŸŸ¦ J. cluster_profile (Phase 3 ì‹ ê·œ ìŠ¤í‚¤ë§ˆ / í´ëŸ¬ìŠ¤í„° ê¸°ë°˜ Prior)


JSON


{
  "cluster_id": "string",                      // PK

  "centroid_embedding": ["number"],
  "category_vector":  ["number"],
  "strength_vector":  ["number"],
  "language_vector":  ["number"],

  "user_count": "int",

  "last_updated": "datetime",
  "schema_version": "string"
}




ğŸŸ¦ K. full_document_store (Phase 1.5 Macro ì›ë³¸ ì €ì¥ì†Œ)

ì„¤ëª…: ë¬¸ì„œ ì „ì²´ì˜ Diff ê¸°ë°˜ ì €ì¥ + LLM ë¶„ì„ì˜ ë‹¨ì¼ ì†ŒìŠ¤.

JSON


{
  "doc_id": "string",                          // PK

  "blocks": [
    {
      "block_index": "int",
      "text": "string"
    }
  ],

  "latest_full_text": "string",
  "previous_full_text": "string|null",

  "diff_ratio": "number",                      // ë¶„ì„ìš©
  "last_synced_at": "datetime",

  "schema_version": "string"
}
diff_ratio ê³„ì‚° ê³µì‹ (ì •ì˜ ì¶”ê°€)

ê¸°ë³¸ ë°©ì‹:
diff_ratio = levenshtein_distance(prev_full_text, full_text) / max(len(prev_full_text), 1)

ë‹¨, ë¸”ë¡ ë‹¨ìœ„ ë³€ê²½ë„ ê°ì§€í•´ì•¼ í•˜ë¯€ë¡œ ë‹¤ìŒ ë³´ì¡° ê¸°ì¤€ ì‚¬ìš©:

- block_add_ratio = (ì¶”ê°€ëœ block ìˆ˜) / (ì „ì²´ block ìˆ˜)
- block_del_ratio = (ì‚­ì œëœ block ìˆ˜) / (ì „ì²´ block ìˆ˜)

ìµœì¢… diff_ratioëŠ” ë‹¤ìŒ ì¤‘ ìµœëŒ€ê°’ì„ ì‚¬ìš©í•œë‹¤:
diff_ratio = max(
    text_diff_ratio,
    block_add_ratio,
    block_del_ratio
)
text_diff_ratio = levenshtein(prev_full_text, full_text) / max(len(prev_full_text), 1)

block_add_ratio = (#added_blocks) / total_blocks
block_del_ratio = (#deleted_blocks) / total_blocks

diff_ratio = max(text_diff_ratio, block_add_ratio, block_del_ratio)




ğŸŸ¦ L.editor_document_snapshot


JSON


{
  "snapshot_id": "string",         // PK, UUID
  "doc_id": "string",
  "user_id": "string",

  "blocks": [
    {
      "block_index": "int",
      "text": "string"
    }
  ],

  "full_text": "string",           // ì „ì²´ ë¬¸ì„œ í•©ì³ì§„ í…ìŠ¤íŠ¸
  "prev_full_text": "string|null", // ë°”ë¡œ ì§ì „ ìŠ¤ëƒ…ìƒ·ì—ì„œ ê°€ì ¸ì˜´ (ì„œë²„ ì¸¡)
  "cursor_position": "int|null",   // í”„ë¡ íŠ¸ì—ì„œ ì „ë‹¬ ê°€ëŠ¥

  "snapshot_version": "string",    // v1.0
  "schema_version": "string",

  "created_at": "datetime"
}

diff_ratioëŠ” ETLì´ full_text vs prev_full_textë¥¼ ë¹„êµí•˜ì—¬ ê³„ì‚°í•œë‹¤.




ğŸ“˜ PART 4 â€” íŠ¸ëœì­ì…˜ ì „ì²´ ì¬ì‘ì„±ë³¸ (v2.3)


ì „ì²´ ì‹œìŠ¤í…œì˜ ì‹¤ì œ ë™ì‘ íë¦„ì„ ì‹œí€€ìŠ¤ì™€ ë‹¨ê³„ë³„ë¡œ ì •í™•íˆ ëª…ì„¸


ğŸ”µ 4.1 ì „ì²´ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨(ì™„ì „ ì¬ì‘ì„±ë³¸)

ì´ ë‹¤ì´ì–´ê·¸ë¨ì€ ì¶”ì²œ(A) â†’ ì‹¤í–‰(B) â†’ ì„ íƒ(C) â†’ ì •ë‹µì§€(D) â†’ ì»¨í…ìŠ¤íŠ¸ ì €ì¥(E/K) â†’ ìºì‹±(F/G) ì˜ ì „ì²´ íŠ¸ëœì­ì…˜ì„ í•œ ë²ˆì— ë³´ì—¬ì¤€ë‹¤.

ì½”ë“œ ìŠ¤ë‹ˆí«


sequenceDiagram
    autonumber
    actor User as ì‚¬ìš©ì
    participant FE as í”„ë¡ íŠ¸ì—”ë“œ
    participant API as ì¶”ì²œ API ì„œë²„
    participant CacheF as F(document_context_cache)
    participant CacheG as G(user_profile)
    participant VDB as Vector DB(E/global)
    participant MQ as ë©”ì‹œì§€í(Kafka/SQS)
    participant DB as DB(K/E/D/F/G/H/K)

    %% ------- 1. ì¶”ì²œ ìš”ì²­ (A) -------
    User->>FE: ë¬¸ì¥ ë“œë˜ê·¸
    FE->>API: /recommend(doc_id, context_text, user_id)

    %% --- Phase ì¡°ê±´ì— ë”°ë¼ Macro/User Profile ì¡°íšŒ ---
    API->>CacheF: macro_context ì¡°íšŒ(doc_id)\n(Phase 1.5+)
    CacheF-->>API: macro_category_hint(P_doc)

    API->>CacheG: user_profile ì¡°íšŒ(user_id)\n(Phase 3+)
    CacheG-->>API: user feature(P_user)

    %% --- Vector Search (Micro Context) ---
    API->>VDB: vector search(context embedding v1)
    VDB-->>API: P_vec

    API->>API: P_final = (1-Î±)P_vec + Î±P_doc + ...

		API --> FE: ì¶”ì²œ ì˜µì…˜ ë¦¬ìŠ¤íŠ¸ + insert_id + recommend_session_id ë°˜í™˜
    FE-->>User: ì¶”ì²œ í›„ë³´ í™”ë©´ í‘œì‹œ

    %% ------- 2. ì¶”ì²œ ì´ë²¤íŠ¸ ì €ì¥ (A / I / E) -------
    API->>MQ: editor_recommend_options(A) ë°œí–‰
    API->>MQ: recommend_log(I) ë°œí–‰
    API->>MQ: context_block(E) ë°œí–‰

    par ë¹„ë™ê¸° ì €ì¥
        MQ->>DB: A ì €ì¥(editor_recommend_options)
        MQ->>DB: I ì €ì¥(recommend_log)
        MQ->>DB: E ì €ì¥(context_block)\n(embedding_v1, preview)
    end
		API --> EmbeddingModel : context embedding ìƒì„±

    %% ------- 3. ë¬¸ì„œ ì €ì¥ (Full Document Store - K) -------
    User->>FE: ë¬¸ì„œ ì €ì¥/ìë™ì €ì¥
    FE->>MQ: editor_document_snapshot ë°œí–‰
    MQ->>DB: full_document_store(K) ì—…ë°ì´íŠ¸\n(latest_full_text, diff_ratio)

		ETL --> MacroLLM : ë¬¸ì„œ ì „ì²´ ë¶„ì„

		%% ------- 4. ì‹¤í–‰(B) - LLM í˜¸ì¶œë§Œ ë°œìƒ -------
		User->>FE: ì‹¤í–‰ ë²„íŠ¼ í´ë¦­
		FE->>MQ: editor_run_paraphrasing(B)\n(source_recommend_event_id í¬í•¨)
		MQ->>DB: B ì €ì¥(editor_run_paraphrasing)
		MQ --> ParaphrasingLLM : í›„ë³´ ë¬¸ì¥ paraphrase ìƒì„±
		
		%% ------- 5. ì„ íƒ(C) + ì •ë‹µì§€ ìƒì„±(D) -------
		User->>FE: í›„ë³´ ì¤‘ 1ê°œ ì„ íƒ
		FE->>MQ: editor_selected_paraphrasing(C)\n(index, was_accepted)
		
		par
				MQ->>DB: C ì €ì¥(editor_selected_paraphrasing)
				MQ->>DB: (if C.was_accepted) correction_history(D) ìƒì„±
				MQ->>DB: C.correction_history_id ì—…ë°ì´íŠ¸ (D._id)		    
		end
		
    %% ------- 6. (Offline) Macro Context ìºì‹œ ê°±ì‹  (F) -------
    DB->>DB: ETL ì½ê¸°(K.full_document_store)
    DB->>DB: LLM Macro ë¶„ì„(macro_topic, macro_category_hint)
    DB->>CacheF: document_context_cache(F) ê°±ì‹ \n(valid_until + TTL)

    %% ------- 7. (Offline) User Profile ìƒì„± (G) -------
    DB->>DB: ETL ì¡°ì¸(B, C, D)
    DB->>CacheG: user_profile ì—…ë°ì´íŠ¸\n(preferred dist, accept rate, embeddings)




ğŸ”µ 4.2 Step-by-step ì²˜ë¦¬ íë¦„ (ëª¨ë“  ë‹¨ê³„ ìƒì„¸ ì‘ì„±)

ì´ 7ë‹¨ê³„ë¡œ ë‚˜ëˆ„ì–´, ì‹¤ì œ ì‹œìŠ¤í…œì´ ì–´ë–¤ ìˆœì„œë¡œ ì›€ì§ì´ëŠ”ì§€ ì„¤ëª…í•œë‹¤.

â‘  ì¶”ì²œ í˜¸ì¶œ ë‹¨ê³„ (A â€” editor_recommend_options)


ì…ë ¥

doc_id
user_id
selected_text
context_prev
context_next
(Phase 2 ì´í›„) context embedding v1

ì²˜ë¦¬ ë¡œì§

APIëŠ” selected_text, context_prev, context_nextë¥¼ ì¡°í•©í•˜ì—¬ context_fullì„ ìƒì„±
context_hash ê³„ì‚° (hash(doc_id + context_full))
context_hash ê¸°ì¤€ìœ¼ë¡œ E.context_block ì¡°íšŒ (Upsert)
(Upsert ì‹œ) EmbeddingModel(context_full)ì„ í˜¸ì¶œí•˜ì—¬ embedding_v1 ìƒì„± ë° ì €ì¥
embedding_v1ì„ ì¿¼ë¦¬ë¡œ Vector Search(P_vec) ìˆ˜í–‰
(Rule Engine ì œê±°ë¨)
Phase ì¡°ê±´ì— ë”°ë¼:
Phase 1 â†’ P_doc = default, P_user = default
Phase 1.5 â†’ P_doc í™œì„± (ë¬¸ì„œ ì„±ìˆ™ë„ì— ë”°ë¥¸ Î± ì ìš©)
Phase 3 â†’ P_doc + P_user í™œì„±
P_final = (1 - Î±) * P_vec + Î± * P_doc + ...
insert_id ìƒì„± â†’ FEë¡œ ë°˜í™˜
APIëŠ” A / I / E 3ê°œì˜ ì´ë²¤íŠ¸ë¥¼ MQë¡œ ë°œí–‰í•œë‹¤.

ì¶œë ¥

ì¶”ì²œ í›„ë³´ ë¦¬ìŠ¤íŠ¸
insert_id (= source_recommend_event_id)

â‘¡ ì¶”ì²œ ê²°ê³¼ ì €ì¥(A), ì¶”ì²œ ë¡œê·¸(I), ì»¨í…ìŠ¤íŠ¸ ì €ì¥(E)


ì €ì¥ë˜ëŠ” ìŠ¤í‚¤ë§ˆ

A â†’ editor_recommend_options
I â†’ recommend_log
E â†’ context_block

ì—­í• 

A = ì¶”ì²œ ê²°ê³¼ì˜ "ì…ì¶œë ¥ ì „ì²´ ìŠ¤ëƒ…ìƒ·"
I = ì¶”ì²œ ë¡œì§ ë‚´ë¶€ì˜ ëª¨ë¸ score/weight ê¸°ë¡
E = Micro-context ì €ì¥ì†Œ (Phase 2 Vector Hybridì˜ ê¸°ë°˜)

â‘¢ ë¬¸ì„œ ì €ì¥ â†’ Macro ì›ë³¸ ì €ì¥(K.full_document_store)


íë¦„

ì‚¬ìš©ìê°€ ë¬¸ì„œ ì €ì¥/ìë™ì €ì¥ì„ í•˜ë©´ FEëŠ” editor_document_snapshot ë°œí–‰
MQê°€ ìˆ˜ì‹ í•˜ì—¬ K í…Œì´ë¸” ì—…ë°ì´íŠ¸
FE â†’ MQ(snapshot ì „ë‹¬)
MQ consumer â†’
K.previous_full_text â† K.latest_full_text
K.latest_full_text â† snapshot.full_text
diff_ratio ê³„ì‚°
blocks ì—…ë°ì´íŠ¸
í…ìŠ¤íŠ¸ë¥¼ ë¸”ë¡ë³„ë¡œ ì €ì¥í•˜ê³  diff_ratioë¥¼ ê¸°ë¡

ì—­í• 

Macro Context ë¶„ì„(F.document_context_cache)ì˜ ìœ ì¼í•œ ì›ë³¸ ì €ì¥ì†Œ

â‘£ ì‹¤í–‰(B) ì²˜ë¦¬


íë¦„

ì‚¬ìš©ìê°€ â€œì‹¤í–‰â€ì„ ëˆ„ë¥´ë©´ FEëŠ” editor_run_paraphrasing ë°œí–‰
LLM ì•„ì›ƒí’‹ ìƒì„± + ì‹¤í–‰ íŒŒë¼ë¯¸í„° ë¡œê·¸ë§Œ ë‚¨ê¹€
B ì´ë²¤íŠ¸ì—:
source_recommend_event_idë¥¼ í¬í•¨í•˜ì—¬ ì €ì¥
B ì´ë²¤íŠ¸ì—ëŠ” correction_history_idê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤.B ì €ì¥ ìŠ¤í‚¤ë§ˆëŠ” ë‹¤ìŒ ë‘ ê°’ë§Œ ê°€ì§„ë‹¤:
source_recommend_event_id (A.insert_id)
recommend_session_id
correction_history_idëŠ” C(ì„ íƒ)ê°€ ë°œìƒí•œ ìˆœê°„D(correction_history)ê°€ ìƒì„±ë˜ë©´ì„œ ë¶€ì—¬ë˜ê³ ,C ì´ë²¤íŠ¸ì—ë§Œ ì €ì¥ëœë‹¤.B ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‹œ MQ consumerëŠ” Paraphrasing LLMì„ í˜¸ì¶œí•˜ì—¬ ì˜µì…˜ í›„ë³´ë¥¼ ìƒì„±í•œë‹¤.ì´ LLM í˜¸ì¶œì€ ì‹¤í–‰(B) ì‹œì ì—ì„œë§Œ ë°œìƒí•˜ë©°, D ìƒì„±ê³¼ëŠ” ë¬´ê´€í•˜ë‹¤.

ì—­í• 

ì‹¤í–‰ ì‹œì ì˜ â€œì‚¬ìš©ì ì„¤ì •ê°’ Ground Truthâ€
D ìŠ¤í‚¤ë§ˆì™€ A ì´ë²¤íŠ¸ë¥¼ Micro-Context ë‚´ì—ì„œ ì—°ê²°í•˜ëŠ” í•µì‹¬ Linker
BëŠ” correction_history(D)ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ì°¸ì¡°í•˜ì§€ ì•ŠëŠ”ë‹¤.
BëŠ” ì˜¤ì§ source_recommend_event_idì™€ recommend_session_idë§Œ ê°€ì§„ë‹¤.
DëŠ” ë°˜ë“œì‹œ C(editor_selected_paraphrasing)ê°€ ë°œìƒí–ˆì„ ë•Œ ìƒì„±ëœë‹¤.

â‘¤ ì„ íƒ(C) ì²˜ë¦¬


íë¦„

ì‚¬ìš©ìê°€ í›„ë³´ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ë©´ FEëŠ” editor_selected_paraphrasing ë°œí–‰
MQê°€ DBì— ì €ì¥
C ì´ë²¤íŠ¸ì—ë„:
source_recommend_event_id
correction_history_idê°€ í¬í•¨ë˜ì–´ì•¼ í•¨
ì´ë•Œ ìƒˆ Dë¥¼ ìƒì„±í•˜ê³ , ê·¸ _idë¥¼ Cì— ì‹¬ëŠ”ë‹¤

ì—­í• 

ì„ íƒ ì—¬ë¶€(was_accepted) Ground Truth
B, Dì™€ì˜ ì¡°ì¸ì„ í†µí•´ user_profile(G)ì™€ training_examples(H) ìƒì„±

â‘¥ Macro Context Cache ê°±ì‹ (F)


ì†ŒìŠ¤

K.full_document_store

í”„ë¡œì„¸ìŠ¤

ETLì€ K.full_document_storeë¥¼ LLMì—ê²Œ ì „ë‹¬í•˜ì—¬ macro_topic, macro_category_hintë¥¼ ì¶”ë¡ í•œë‹¤.
ì´ Macro LLM í˜¸ì¶œì€ diff_ratio â‰¥ 10% ë˜ëŠ” TTL ë§Œë£Œ ì‹œì—ë§Œ ë°œìƒí•œë‹¤.
ETLì´ K í…Œì´ë¸”ì„ ì½ì–´ ë¬¸ì„œ ë‹¨ìœ„ full_text ì¬êµ¬ì„±
diff_ratioâ‰¥X%ì´ë©´ ìºì‹œ ë¬´íš¨í™”
LLM ë¶„ì„ìœ¼ë¡œ:
macro_topic
macro_category_hint
Redis ë“± ìºì‹œì— ì €ì¥ (TTL ë¶€ì—¬)

ê²°ê³¼

/recommend APIì—ì„œ doc_id ì¡°íšŒ ì‹œ ì¦‰ì‹œ P_doc ë°˜ì˜

â‘¦ User Profile ìºì‹œ(G) ìƒì„±


ì†ŒìŠ¤

C (was_accepted)
D (field, intensity, user_prompt)
B (target_language)

ì¶œë ¥

preferred distributions
recommend_accept_rate
user_embedding_v1
Phase 3ì—ì„œ /recommendí•  ë•Œ ì¦‰ì‹œ ì¡°íšŒë˜ì–´ P_user ê³„ì‚°ì— ì‚¬ìš©ë¨.

ğŸ”µ 4.3 A â†” B â†” C â†” D í‚¤ ì—°ê²° ê·œì¹™ (Consistency Rule)

ì´ ê·œì¹™ì´ ì§€ì¼œì ¸ì•¼ ETL/í•™ìŠµ ë°ì´í„°(H)ì—ì„œ 100% ì •í•©ì„± ìˆëŠ” ë ˆì½”ë“œë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

Rule 1 â€” recommend_session_id (ë…¼ë¦¬ì  ì„¸ì…˜ ID)

A ìƒì„± ì‹œ ìƒì„±ë¨
~~B/C/D/Hì—ì„œ ë°˜ë“œì‹œ ë™ì¼í•œ recommend_session_idë¥¼ ê³µìœ í•´ì•¼ í•¨~~
A/B/Cë§Œ recommend_session_idë¥¼ ê³µìœ í•˜ë©°
DëŠ” recommend_session_idë¥¼ ê°€ì§€ì§€ ì•ŠëŠ”ë‹¤.
DëŠ” C.correction_history_idë¡œë§Œ ì—°ê²°ëœë‹¤.
ETLì—ì„œ DëŠ” (correction_history_id)ë¡œ JOINí•œë‹¤.
ì„¸ì…˜ ë‹¨ìœ„ ë¶„ì„ì— ì‚¬ìš©ë¨
ì˜ˆ: í•œ ë¬¸ì¥ ë“œë˜ê·¸ â†’ ì‹¤í–‰ â†’ ì„ íƒì˜ ì „ì²´ íë¦„ì„ ë¬¶ëŠ” í‚¤

Rule 2 â€” source_recommend_event_id (= A.insert_id)

A.insert_idëŠ” Mixpanel insert_idì™€ ë™ì¼
Bì™€ CëŠ” ë°˜ë“œì‹œ ì´ ê°’ì„ FKë¡œ í¬í•¨í•´ì•¼ í•œë‹¤
ìˆ˜í–‰ ì›ì²œì´ ì–´ë–¤ ì¶”ì²œ(A)ì´ì—ˆëŠ”ì§€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì§€í‘œ

Rule 3 â€” correction_history_id (= D._id)

C ì´ë²¤íŠ¸ê°€ triggerê°€ ë˜ì–´ D(correction_history)ë¥¼ ìƒì„±í•œë‹¤.
Dê°€ ìƒì„±ë˜ë©´:
D._idë¥¼ ìƒì„±í•œë‹¤.
C.correction_history_id = D._idë¡œ ì„¸íŒ…í•œë‹¤.
BëŠ” correction_history_idë¥¼ ê°–ì§€ ì•Šê³ , A/B/CëŠ” source_recommend_event_id + recommend_session_idë¡œ ë¬¶ì¸ë‹¤.
ìµœì¢… Ground Truth(D)ë¥¼ ì—¬ëŸ¬ ì´ë²¤íŠ¸(B/C)ê°€ ì°¸ì¡°í•˜ëŠ” êµ¬ì¡°
DëŠ” í…ìŠ¤íŠ¸Â·ì„¤ì •ê°’ì˜ ìµœì¢… ê·¼ê±°

Rule 4 â€” doc_id ì •í•©ì„±

ëª¨ë“  ì´ë²¤íŠ¸ê°€ ë°˜ë“œì‹œ ë™ì¼ doc_idë¥¼ ê°€ì ¸ì•¼ í•¨
(ë‹¤ë¥´ê²Œ ë˜ë©´ Macro Context(K/F)ì™€ Micro Context(E)ê°€ ì—‰í‚´)

Rule 5 â€” Phase ì¡°ê±´ì— ë”°ë¥¸ P_doc/P_user ê·œì¹™

Phase
P_vec
P_doc
P_user
1
ON
default(0)
default(0)
1.5
ON
ON (ë™ì ê°€ì¤‘ì¹˜)
default(0)
2
ON (Hybrid ì¤€ë¹„)
ON
default(0)
3
ON
ON
ON


ğŸ”µ 4.4 ìºì‹œ ë¬´íš¨í™” / ì¬ê³„ì‚° ê·œì¹™


Rule 1 â€” Macro Cache(F) ë¬´íš¨í™”

diff_ratio â‰¥ 0.10 (10% ì´ìƒ ë³€ê²½) â†’ í•´ë‹¹ doc_id ìºì‹œ ì‚­ì œ
diff_ratio < 0.10 â†’ TTL ë‚´ ìœ ì§€

Rule 2 â€” User Profile(G) ì¬ê³„ì‚°

í•˜ë£¨ 1íšŒ ê¸°ë³¸
ë‹¤ìŒ ì¡°ê±´ ì¤‘ í•˜ë‚˜ë¼ë„ ë§Œì¡±í•˜ë©´ ì¦‰ì‹œ ì¬ê³„ì‚°:
ìµœê·¼ 10ê±´ì—ì„œ was_accepted ë³€í™”ëŸ‰ì´ 20% ì´ìƒ
ìƒˆë¡œìš´ user_promptê°€ ì¶”ê°€ë¨
ìƒˆë¡œìš´ field/intensityê°€ ìœ ì…ë¨

ğŸ”µ 4.5 Training Examples(H) ìƒì„± ê·œì¹™

ETLì€ ë‹¤ìŒ 7ê°œ ì—”í‹°í‹°ë¥¼ Joiní•˜ì—¬ 1ê°œì˜ sampleì„ ìƒì„±í•œë‹¤:
ì—”í‹°í‹°
ì—­í• 
A
ì¶”ì²œ ì…ë ¥ê°’
I
ëª¨ë¸ ì ìˆ˜/ê°€ì¤‘ì¹˜
E
context embedding
F
macro hint ì…ë ¥
B
ì‹¤í–‰ ì‹œ ì„¤ì • Ground Truth
C
ì„ íƒ ì—¬ë¶€ Ground Truth
D
í…ìŠ¤íŠ¸ Ground Truth


ğŸ”µ 4.6 ìµœì¢… ìš”ì•½ â€” ì¶”ì²œ â†’ ì‹¤í–‰ â†’ ì„ íƒ â†’ í•™ìŠµì˜ ì™„ì „ ë£¨í”„

A: ì¶”ì²œ ìƒì„± (API)
Consumer: A/I/Eë¥¼ Kafkaì—ì„œ ì½ì–´ MongoDBì— ë°°ì¹˜ ì €ì¥
Consumer: ë¬¸ì„œ ìŠ¤ëƒ…ìƒ·(K) ì €ì¥ ë° Diff ê³„ì‚°
B: ì‹¤í–‰ (API â†’ Kafka â†’ Consumer ì €ì¥)
D: ì •ë‹µì§€ ìƒì„± (Consumer or API)
C: ì„ íƒ (API â†’ Kafka â†’ Consumer ì €ì¥)
ETL: F/G ìºì‹œ ê°±ì‹  (Redis)
ETL: H(í•™ìŠµ ë°ì´í„°) ìƒì„± (MongoDB Join)
Dashboard: ë°ì´í„° ì¡°íšŒ ë° ì‹œê°í™”
ë‹¤ì‹œ Aì—ì„œ P_user/P_doc ë°˜ì˜ â†’ í’ˆì§ˆ í–¥ìƒ
ì™„ì „í•œ ê°•í™”(loop) êµ¬ì¡° ì™„ì„±.
