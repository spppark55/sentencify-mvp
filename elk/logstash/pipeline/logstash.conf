input {
  kafka {
    bootstrap_servers => "kafka:9092"
    topics => ["editor_recommend_options", "editor_run_paraphrasing", "editor_selected_paraphrasing", "recommend_log", "context_block"]
    group_id => "logstash_consumer_group"
    auto_offset_reset => "earliest"
    # codec => "json"  <-- Removed to avoid InvalidFieldSetException
    type => "raw_log"
  }
}

filter {
  # Explicitly parse the JSON message
  json {
    source => "message"
    # remove_field => ["message"] # Optional: Keep original message for debugging if needed
  }

  # Timestamp handling
  if [created_at] {
    date {
      match => [ "created_at", "ISO8601" ]
      target => "@timestamp"
    }
  }
}

output {
  # Debugging output
  stdout { codec => rubydebug }

  # Elasticsearch ingestion
  if [type] == "raw_log" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "sentencify-logs-%{+YYYY.MM.dd}"
    }
  }
}
